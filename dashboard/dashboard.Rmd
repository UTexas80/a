---
title: "S-Curve Dashboard"
output:
  flexdashboard::flex_dashboard:
    orientation: row
    source_code: embed
    vertical_layout: fill
date: "`r params$reportdate`"
resource_files:
- dashboard/rds/dt_blob.rds
- dashboard/rds/dt_plt_data.rds
- dashboard/rds/dt_plt_quad_pct.rds
- reports/monmouth-ocean_msa.png
- reports/nashville_msa.png
- reports/orlando_msa.png
runtime: shiny
theme: spacelab
params:
  dateEnd: !r Sys.Date()
  dateStart: '2002-01-02'
  dynamictitle: market share saturation report
  reportDate:
    input: date
    label: 'Report Date:'
    value: as.POSIXct(Sys.Date())
---

```{r global, echo=FALSE, include=FALSE, message = FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard
knitr::opts_knit$set(root.dir = "..", echo = FALSE)

library(animation)
library(ARTofR)
library(archivist)
library(av)
library(bbplot) 
library(bcp)
library(beepr)
library(bookdown)
library(bookdownplus)
library(changepoint)
library(changepoints)
library(data.table)
library(devtools)
library(DT)
library(easystats)
library(ezknitr)
library(farver)
library(generics)
library(ggbump)
library(fuzzyjoin)
library(ggalt)
library(gganimate)
library(ggblanket)
library(ggcharts)
library(ggdark)
library(ggdist)
library(ggeasy)
library(ggforce)
library(gghighlight)
library(ggimage)
library(ggiraph)
library(ggpmisc)
library(ggpackets)
library(ggplot2)
library(ggrepel)
library(ggthemes)
library(ggsci)
library(ggtext)
library(ggthemr)
library(gifski)
library(heatmaply)
library(highcharter)
library(hrbrthemes)
library(htmltools)
library(htmlwidgets)
library(inflection)
library(knitr)
library(lattice)
library(latticeExtra)
library(magrittr)
library(markdown)
library(paletteer)
library(plotly)
library(png)
library(pracma)
library(quantmod)
library(RColorBrewer)
library(scales)
library(sicegar)
library(sigmoid)
library(stringr)
library(tibble)
library(tidyverse)
library(xts)
library(zoo)
```

```{r rdsInput}
# ------------------------------------------------------------------------------
dt.data.out     <- setDT(data.table(readRDS(here::here("dashboard/rds/", "dt.data.out.rds"))))
# ------------------------------------------------------------------------------
dt.brand.type   <- setDT(data.table(readRDS(here::here("dashboard/rds/", "dt.brand.type.rds"))))
dt.date         <- setDT(data.table(readRDS(here::here("dashboard/rds/", "dt.date.rds"))))
dt.logo         <- setDT(data.table(readRDS(here::here("dashboard/rds/", "dt.logo.rds"))))
dt.mkt.share    <- setDT(data.table(readRDS(here::here("dashboard/rds/", "dt.mkt.share.rds"))))
dt.msa          <- setDT(data.table(readRDS(here::here("dashboard/rds/", "dt.msa.rds"))))
dt.region       <- setDT(data.table(readRDS(here::here("dashboard/rds/", "dt.region.rds"))))
dt.roi          <- setDT(data.table(readRDS(here::here("dashboard/rds/", "dt.roi.rds"))))
dt.source       <- setDT(data.table(readRDS(here::here("dashboard/rds/", "dt.source.rds"))))
# ------------------------------------------------------------------------------
dt_blob         <- setDT(data.table(readRDS(here::here("dashboard/rds/", "dt_blob.rds"))))
dt_mon_quad     <- setDT(data.table(readRDS(here::here("dashboard/rds/", "dt_mon_quad.rds"))))
dt_plt_data     <- setDT(data.table(readRDS(here::here("dashboard/rds/", "dt_plt_data.rds"))))
dt_plt_quad_pct <- setDT(data.table(readRDS(here::here("dashboard/rds/", "dt_plt_quad_pct.rds"))))
dt_quadrant <- setDT(data.table(readRDS(here::here("dashboard/rds/", "dt_quadrant.rds"))))
# ------------------------------------------------------------------------------
```

```{r functions,  global, echo=FALSE, include=FALSE, message = FALSE}

#...............................................................................
# s-curve plot                                  https://tinyurl.com/ye27758j ...
#...............................................................................
test_function   <- function(dt) 
{
#  browser()
  renderPlotly({
    dt_data <- data.table
    (
      dt[date_start == input$date_start.0.0.4[1]]
    )
    ggplotly(
      ggplot(
        data = dt) +
        aes(x = x) +
        labs(x = "the x label") +
        aes(y = y) +
        labs(y = "the y label") +
        geom_point() +
        aes(col = y2) +
        labs(col = "legend title") +
        labs(title = "My title")
      )
  })
}
#...............................................................................
fun_plt_scurve  <- function(dt) {
#...............................................................................
# browser()

renderPlotly({
# ------------------------------------------------------------------------------  
  dt_data <- data.table  (
    dt[
#      msa        == 1 & 
      brand_type == input$radio.0.0.2 & 
      date_start == as.Date(input$date_start.0.0.4),
#     date_start == as.Date("2022-07-02"),
      ]
    )
# ------------------------------------------------------------------------------  
  msa                 <- unique(dt_data[dt.msa, on = .(msa = id), nomatch = 0][,5])
# ------------------------------------------------------------------------------
  x                   <- dt_data$x
  y                   <- dt_data$y
# ------------------------------------------------------------------------------
# MER line processing
# ------------------------------------------------------------------------------
  my_slope            <- slope(dt_data$x, dt_data$x)
  my_intercept        <- intercept(dt_data$x, dt_data$x, my_slope)
# ------------------------------------------------------------------------------
  plt_scurve          <- ggplotly(
      ggplot(,
        aes(
          x = dt_data$x,
          y = dt_data$y,
          xend = max(dt_data$x),
          yend = max(dt_data$y)),
          label = label) +
  geom_point(
    colour = dt_data$y2,
    size = 2) +
# ------------------------------------------------------------------------------
# mer slope line / s-curve boundry lines
# ------------------------------------------------------------------------------
  geom_abline(intercept = 0, slope = 1,  color = "blue", size = 0.75) +
# ------------------------------------------------------------------------------
  geom_vline(xintercept = dt_data$boundry_left,  color = "blue", size = 0.250) +
  geom_vline(xintercept = dt_data$boundry_right, color = "blue", size = 0.250) +
# ------------------------------------------------------------------------------
# shaded boundary area
# ------------------------------------------------------------------------------
  geom_rect(
    aes(xmin = dt_data$boundry_left,
        xmax = dt_data$boundry_right,
        ymin = -Inf,
        ymax = Inf),
        fill = "blue",
        colour = NA,
        alpha = 0.05)  +
# ------------------------------------------------------------------------------
# Sigmoid s-curve - Add s curve to r ggplot         https://tinyurl.com/bdfefdvh
# Step 00.02: add-s-curve-to-r-ggplot               https://tinyurl.com/bdfefdvh
# ------------------------------------------------------------------------------
  geom_sigmoid(data = dt_data,
    aes(x    = min(dt_data$x),
        xend = max(dt_data$x),
        y    = min(dt_data$y),
        yend = max(dt_data$y))) +
# ------------------------------------------------------------------------------
# label text 
# ------------------------------------------------------------------------------
  geom_text(
#    aes(label = label)) +
    aes(label = dt_data$label),
    hjust = 1.30,
    vjust = 1.00) +
# ------------------------------------------------------------------------------
# Title
# ------------------------------------------------------------------------------
  ggtitle(paste0(stringr::str_to_title(dt_data$msa_name), " MSA - Market Share Saturation"),
          subtitle = "July 2017") +
  ggeasy::easy_center_title()  +
# ------------------------------------------------------------------------------
# Add multiple text ranges to plot boundary
# ------------------------------------------------------------------------------
  annotate("text",
    x = (dt_data$boundry_left / 2),
    y = (max(dt_data[,6]) * 20) + .19,
    label = "GROW") +
  annotate("text",
    x = (dt_data$boundry_left + dt_data$boundry_right) / 2,
    y = (max(dt_data[,6]) * 20) + .19,
    label = "OPTIMISE") +
  annotate("text",
    x = (max(dt_data$boundry_right + max(dt_data$x)))/2,
    y = (max(dt_data[,6]) * 20) + .19,
    label = "CANNIBALISE")  +
# ------------------------------------------------------------------------------
# x & y axis
# ------------------------------------------------------------------------------
  labs(x = "Outlet Share", y = "Market Share")  +
  scale_x_continuous(
    labels = scales::percent_format(accuracy = 1)
  ) +
  scale_y_continuous(
    breaks = c(0.05, 0.10, 0.15, 0.20, 0.25, 0.30, 0.35),
    labels = scales::percent_format(accuracy = 1),
    limits = c(0, 0.35)
  )
          
      ) 
  })
}
#...............................................................................
# * Setup a ggplot cyberpunk theme ----
#...............................................................................
theme_cyberpunk <- function() {
  
  clrs <- colorRampPalette(c("#00ff9f", "#00b8ff", "#001eff", "#bd00ff", "#d600ff"))(7)

  clr_bg   <- "black"
  clr_bg2  <- "gray10"
  clr_grid <- "gray30"
  clr_text <- "#d600ff"
  
    theme(
        # Plot / Panel
        plot.background = element_rect(fill = clr_bg, colour = clr_bg),
        # plot.margin = margin(1.5, 2, 1.5, 1.5, "cm"),
        panel.background = element_rect(fill = clr_bg, color = clr_bg),
        # Grid
        panel.grid = element_line(colour = clr_grid, size = 1),
        panel.grid.major = element_line(colour = clr_grid, size = 1),
        panel.grid.minor = element_line(colour = clr_grid, size = 1),
        axis.ticks.x = element_line(colour = clr_grid, size = 1),
        axis.line.y = element_line(colour = clr_grid, size = 0.5),
        axis.line.x = element_line(colour = clr_grid, size = 0.5),
        # Text
        plot.title = element_text(colour = clr_text),
        plot.subtitle = element_text(colour = clr_text),
        axis.text = element_text(colour = clr_text),
        axis.title = element_text(colour = clr_text),
        # Legend
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.title = element_text(colour = clr_text),
        legend.text = element_text(colour = "gray80", size = 12, face = "bold"),
        # Strip
        strip.background = element_rect(fill = clr_bg2, color = clr_bg2)
    )
}

dayDifff        <- function(X)
{
    as.numeric(as.Date(index(X))) - c(NA, as.numeric(as.Date(index(X[-nrow(X)]))))
}
```

```{r processing, global, fig.align = 'center', echo=FALSE, include=FALSE, message = FALSE}

fun_scurve_monmouth <- function(msa)
{
# ------------------------------------------------------------------------------    
 renderImage({
# ------------------------------------------------------------------------------      
    brand_type <- dt.brand.type[id == input$radio.0.0.2,][,2]
    date_start <- input$date_start.0.0.4[1]
    dt_start   <- format(as.Date(input$date_start.0.0.4), format =  "%Y%m")
    msa        <- dt.msa[id == 1,][,2]
    plt_url    <- tolower(paste0(paste("png", dt_start, msa, brand_type, sep = "_"),".png"))
# ------------------------------------------------------------------------------    
    filename <- here::here("dashboard/png",plt_url)
    list(src    = filename,
        width  = 555,
        height = 416)
  }, deleteFile = FALSE)
# ------------------------------------------------------------------------------  
}

fun_scurve_nashville <- function(msa)
{
# ------------------------------------------------------------------------------    
 renderImage({
# ------------------------------------------------------------------------------      
    brand_type <- dt.brand.type[id == input$radio.0.0.2,][,2]
    date_start <- input$date_start.0.0.4[1]
    dt_start   <- format(as.Date(input$date_start.0.0.4), format =  "%Y%m")
    msa        <- dt.msa[id == 2,][,2]    
    plt_url    <- tolower(paste0(paste("png", dt_start, msa, brand_type, sep = "_"),".png"))
# ------------------------------------------------------------------------------    
    filename <- here::here("dashboard/png",plt_url)
    list(src = filename,
        width  = 555,
        height = 416)
  }, deleteFile = FALSE)
# ------------------------------------------------------------------------------  
}

fun_scurve_orlando <- function(msa)
{
# ------------------------------------------------------------------------------    
 renderImage({
# ------------------------------------------------------------------------------      
    brand_type <- dt.brand.type[id == input$radio.0.0.2,][,2]
    date_start <- input$date_start.0.0.4[1]
    dt_start   <- format(as.Date(input$date_start.0.0.4), format =  "%Y%m")
    msa        <- dt.msa[id == 3,][,2]    
    plt_url    <- tolower(paste0(paste("png", dt_start, msa, brand_type, sep = "_"),".png"))
# ------------------------------------------------------------------------------    
    filename <- here::here("dashboard/png",plt_url)
    list(src = filename,
        width  = 555,
        height = 416)
  }, deleteFile = FALSE)
# ------------------------------------------------------------------------------  
}

```

0.0 USA {data-navmenu="0-USA" data-icon="fa-list"}
=====================================

Input {.sidebar}
-------------------------------------

```{r 0.0.0.1-sidebarInput}

dateRangeInput("dateRange.0.0.1",
  "Date Range",
  start = params$dateStart,
  end = Sys.Date(),
  min = params$dateStart,
  max = Sys.Date()
)
```

```{r 0.0.0.2-sidebarRadio}
radioButtons("radio.0.0.2", "Brand Type:",
              c("Corporate" = 1,
                "Gas" = 2,
                "Store" = 3
              ),
              selected = "1"              
            )
```

```{r 0.0.0.3-sidebarRadio}
radioButtons("radio.0.0.3", "Source:",
              c("Fleet" = 1,
                "Visit Count" = 2
              ), 
              selected = "2"
            )
```

```{r 0.0.0.4-sidebar-listbox}
selectInput("date_start.0.0.4",
  label = "Start Date",
  choices = c("2022-07-02", "2021-07-03", "2017-07-01"),
  selected = "2022-07-02")
```

Welcome to the S-Curve Dashboard!

**Mission:** Saturation Curve is a mathematical curve. Summary
An ongoing challenge for any firm is estimating demand for new products.  This is especially true when the product has new technology or is replacing an existing product and the additional function in the new product is limited. Often a mathematical construction called an S curve is helpful. An S curve has four stages, initial slow growth, rapid growth, late-stage slow growth, and no growth or loss in demand (called stationary demand). 

**Objective:** This dashboard provides an overview of S curves and why they can be helpful.

1. To provide a glimpse of an MSA's Market Share performance.
2. To discern the impact of an S-Curve:
   - in relation to Market Share's influence on ROI.

**Design:** S curves are named based on their shape.  They have four stages:

1. Stage 1 slope is small: in terms of new product introduction, slow growth of market share.
2. Stage 2 slope is large: fast growth in market share, business takes off.
3. Stage 3 slope is small: slow growth to zero growth.
4. Stage 4 slope is zero: no growth in market share.

If you have any questions, or would like to provide feedback please: [email me](mailto:gfalk@opisnet.com)

Thank you for your time and consideration. I hope that you enjoy the site.

```{r 0.0.0.1-sidebar-ActionGo}

```

Column {data-height=12%}
-------------------------------------

###

```{r 0.0.1.1-vbox-legend-usa}
flexdashboard::renderValueBox(
  {

  dt_start   <-  format(as.Date(input$date_start.0.0.4), format =  "%Y%m")
  brand_type <- dt.brand.type[id == input$radio.0.0.2,][,2]
  msa        <- dt.msa[id == 1,][,2]
  plt_url    <- tolower(paste0(paste(dt_start, msa, brand_type, sep = "_"),".png"))
  filename <- here::here("dashboard/png/", paste("png_", plt_url)) 

  flexdashboard::valueBox(
#    as.character(brand_type),
    "USA",
    color = "#123ABC"
    )
  }
)
```

###

```{r 0.0.1.2-vbox-max-outlets}

flexdashboard::renderValueBox(
  {
# ------------------------------------------------------------------------------    
    maxOutlets <- max(dt.mkt.share[brand_type == as.numeric(input$radio.0.0.2),5])
# ------------------------------------------------------------------------------
    flexdashboard::valueBox(
      paste0("Max Outlets: ", as.character(maxOutlets)),
      color = "#123ABC"
    )
# ------------------------------------------------------------------------------  
  }
)
```

###

```{r 0.0.1.3-vbox-max-outlet-share-pct}

flexdashboard::renderValueBox(
  {
# ------------------------------------------------------------------------------    
    maxOutletShare <- percent(max(dt.mkt.share[brand_type == as.numeric(input$radio.0.0.2),7]))
# ------------------------------------------------------------------------------
    flexdashboard::valueBox(
      paste0("Max Outlet Share: ", as.character(maxOutletShare)),
      color = "#123ABC"
    )
# ------------------------------------------------------------------------------  
  }
)
```

###

```{r 0.0.1.4-vbox-max-market-share-pct}

flexdashboard::renderValueBox(
  {
# ------------------------------------------------------------------------------    
    maxMarketShare <- percent(max(dt.mkt.share[brand_type == as.numeric(input$radio.0.0.2),6]))
# ------------------------------------------------------------------------------
    flexdashboard::valueBox(
      paste0("Max Market Share: ", as.character(maxMarketShare)),
      color = "#123ABC"
    )
# ------------------------------------------------------------------------------  
  }

)
```

###

```{r 0.0.1.5-vbox-max-mer-pct}

flexdashboard::renderValueBox(
  {
# ------------------------------------------------------------------------------    
    maxMER <- sprintf(max(dt.mkt.share[brand_type == as.numeric(input$radio.0.0.2),8]), fmt = '%#.2f')
# ------------------------------------------------------------------------------
    flexdashboard::valueBox(
      paste0("Max MER: ", as.character(maxMER)),
      color = "#123ABC"
    )
# ------------------------------------------------------------------------------  
  }
)
```

Row {data-height=44%, .tabset .tabset-fade}
-------------------------------------

### USA Market Share

```{r 0.0.2.1-table-mkt-share, eval=dt.mkt.share}
DT::renderDataTable({
  ind     <- as.numeric(input$radio.0.0.2)
  dt_data <- data.table(dt.mkt.share[brand_type == ind, ])
  dt_data <- dt_data[,c(11,17,16,19,4:5,7:6,8:9)]
  DT::datatable(dt_data,
    rownames = FALSE,
    extensions = c("Scroller"),
    filter = 'top',
    options = list(
      dom = 'ltipr'
      ,order = list(list(0, "desc"))
      ,pageLength = 20
      ,scrollX = TRUE
      ,scrollY = 280
      ,scroller = TRUE)
    ) %>%
    formatDate(c("date_start")) %>%
    formatRound("outlets", 0)   %>%
    formatStyle("outlets",
      background = styleColorBar(range(dt.mkt.share$outlets), "#123ABC"),
      color = "#b22234",
      fontWeight = 'bold'
    ) %>%    
    formatPercentage( c("mkt_share_pct", "outlet_share_pct"),2) %>%
    formatStyle("outlet_share_pct",
      background = styleColorBar(range(dt.mkt.share$outlet_share_pct), "#123ABC"),
      color = "#b22234",
      fontWeight = 'bold'    
    ) %>%
    formatStyle("mkt_share_pct",
      background = styleColorBar(range(dt.mkt.share$mkt_share_pct), "#123ABC"),
      color = "#b22234",
      fontWeight = 'bold'
    )  %>%
    formatRound("mer", 2) %>%
    formatStyle("mer",
      background = styleColorBar(range(dt.mkt.share$mkt_share_pct), "#123ABC"),
      color = "#b22234",
      fontWeight = 'bold'
    ) 
})
```

### MSA MER

```{r 0.0.2.2-viz-box-mer, eval=dt.mkt.share}

renderPlotly({
# ------------------------------------------------------------------------------
    dt.mkt.share    <- data.table(
      dt.mkt.share[
#       msa        == 1 &
        brand_type == input$radio.0.0.2 &
        date_start == as.Date("2022-07-02"),
      ]
    )  
# ------------------------------------------------------------------------------
    dt_monmouth    <- data.table(
      dt.mkt.share[
        msa        == 1 &
        brand_type == input$radio.0.0.2 &
        date_start == as.Date("2022-07-02"),
      ]
    )
# ------------------------------------------------------------------------------
    dt_nashville    <- data.table(
      dt.mkt.share[
        msa        == 2 &
        brand_type == input$radio.0.0.2 &
        date_start == as.Date("2022-07-02"),
      ]
    )
# ------------------------------------------------------------------------------
    dt_orlando    <- data.table(
      dt.mkt.share[
        msa        == 3 &
        brand_type == input$radio.0.0.2 &
        date_start == as.Date("2022-07-02"),
      ]
    )
# ------------------------------------------------------------------------------
  p <- plot_ly(type = "box") %>%
# ------------------------------------------------------------------------------  
      add_boxplot(
        x = dt.mkt.share,
        y = dt.mkt.share$mer,
          jitter    = 0.3,
          pointpos  = -1.8,
          boxpoints = "all",
        marker      = list(color = "rgb(7,40,89)"),
        line        = list(color = "rgb(7,40,89)"),
        name        = "USA"
    ) %>%  
# ------------------------------------------------------------------------------  
      add_boxplot(
        x = dt_monmouth,
        y = dt_monmouth$mer, 
          jitter    = 0.3,
          pointpos  = -1.8,
          boxpoints = "all",
        marker      = list(color = "rgb(7,40,89)"),
        line        = list(color = "rgb(7,40,89)"),
        name        = "Monmouth"
    ) %>%
# ------------------------------------------------------------------------------    
      add_boxplot(
        x = dt_nashville,
        y = dt_nashville$mer, 
          jitter    = 0.3,
          pointpos  = -1.8,
          boxpoints = "all",
        marker      = list(color = "rgb(7,40,89)"),
        line        = list(color = "rgb(7,40,89)"),
        name        = "Nashville"
    ) %>%
# ------------------------------------------------------------------------------    
      add_boxplot(
        x = dt_orlando,
        y = dt_orlando$mer, 
          jitter    = 0.3,
          pointpos  = -1.8,
          boxpoints = "all",
        marker      = list(color = "rgb(7,40,89)"),
        line        = list(color = "rgb(7,40,89)"),
        name        = "Orlando"
    ) %>%    
# ------------------------------------------------------------------------------    
    layout(title = "MSA MER",
      yaxis = list(
      title = '-MER')
    )
  }
)
```

### Sector Pct

```{r 0.0.2.3-viz-bar-sector-pct, eval=dt_plt_quad_pct}

renderPlotly({
# ------------------------------------------------------------------------------  
  plot_ly(
    dt_plt_quad_pct,
    x = ~as.factor(date_start),
    y = ~q01*100, name = "Q01", marker = list(color = "#BA0C2F"),
    type = "bar"
  ) %>%
    add_trace(y = ~q02*100, name = "Q02", marker = list(color = "#cc5500"), type = "bar") %>%
    add_trace(y = ~q03*100, name = "Q03", marker = list(color = "#000000"), type = "bar") %>%
    add_trace(y = ~q04*100, name = "Q04", marker = list(color = "#19488a"), type = "bar") %>%
    add_trace(y = ~q05*100, name = "Q05", marker = list(color = "#7f827c"), type = "bar") %>%
    add_trace(y = ~q06*100, name = "Q06", marker = list(color = "#7034FF"), type = "bar") %>%
    layout   (title          = "MSA Quadrandt Breakdown",
              xaxis          = list(
                title        = "Start Date",
                tickangle    = 0),
              yaxis          = list(
                title        = "Quadrant Pct",
                barmode      = 'group',
                ticksuffix  = '%')
    )
})

```

### Sector Pct Trend

```{r 0.0.2.4-viz-line-sector-pct, eval=dt_plt_quad_pct}

renderPlotly({
# ------------------------------------------------------------------------------
  plot_ly(
    dt_plt_quad_pct,
              x = ~as.factor(date_start), type = 'scatter', mode = 'lines+markers',  yaxis = 'y2',
              y = ~q01*100, name = "Q01", line = list(color = '#000000')) %>%
    add_trace(y = ~q02*100, name = "Q02", line = list(color = '#cc5500')) %>%
    add_trace(y = ~q03*100, name = "Q03", line = list(color = '#000000')) %>%
    add_trace(y = ~q04*100, name = "Q04", line = list(color = '#19488a')) %>%
    add_trace(y = ~q05*100, name = "Q05", line = list(color = '#7f827c')) %>%
    add_trace(y = ~q06*100, name = "Q06", line = list(color = '#7034FF')) %>%
    layout   (title              = "MSA Quadrandt Trend",
              xaxis              = list(
                title            = "Start Date",
                tickangle        = 0),
              yaxis              = list(
                title            = "Quadrant Pct",
                barmode          = 'group',
                ticksuffix       = '%')
    )
})

```

### MSA Sector Heatmap

```{r 0.0.2.5-viz-heatmap-sector-msa, eval=dt_quadrant}

# draw a treepam
renderPlot({
library(d3treeR)

dt_data <- data.table::setorder(dt_quadrant[,c(8:11,5,7)], msa, brand, quadrant)  
  
p <- treemap(dt_data,
             index=c("msa","brand", "quadrant"),
             vSize="pct_quad_cnt",
             type="index",
             palette = "Set2",
             bg.labels=c("white"),
             algorithm = "pivotSize",
             sortID = "msa",
             align.labels=list(
                 c("center", "center"), 
                 c("right", "bottom")
             )  
    ) 
# make it interactive ("rootname" becomes the title of the plot):
      inter <- d3tree3(p ,  rootname = "MSA Quadrant Heatmap")
#      inter <- renderD3tree2({d3tree2(p)})
})
```

### Sector Delta

```{r 0.0.2.6-viz-bar-sector-delta, eval=dt_quadrant}
# knitr::include_graphics(here::here("dashboard/png/", "mon_quad_dlt.png"))
  plot_ly(
    dt_mon_quad,
    x = ~as.factor(index),
    y = ~q01*100, name = "Q01", marker = list(color = "#BA0C2F"),
    type = "bar"
  ) %>%
    add_trace(y = ~q02*100, name = "Q02", marker = list(color = "#cc5500"), type = "bar") %>%
    add_trace(y = ~q03*100, name = "Q03", marker = list(color = "#000000"), type = "bar") %>%
    add_trace(y = ~q04*100, name = "Q04", marker = list(color = "#19488a"), type = "bar") %>%
    add_trace(y = ~q05*100, name = "Q05", marker = list(color = "#7f827c"), type = "bar") %>%
    add_trace(y = ~q06*100, name = "Q06", marker = list(color = "#7034FF"), type = "bar") %>%
    layout   (title          = "MSA Quadrandt Delta",
              xaxis          = list(
                title        = "Start Date",
                tickangle    = 0),
              yaxis          = list(
                title        = "Quadrant Delta",
                barmode      = 'group',
                ticksuffix  = '%')
    )

```

###

```{r 0.0.2.7-viz-box-msa-mer, eval=dt.mkt.share}

# knitr::include_graphics(here::here("dashboard/anim/boxplot", "msa_sector_pct_by_yr.gif"))

```

###
```{r 0.0.2.8-viz-box-msa-mer, eval=dt.mkt.share}
# knitr::include_graphics(here::here("dashboard/anim/sector", "msa_sector_pct_by_yr.gif"))
```

Row {data-height=44%}
-------------------------------------

### Monmouth-Ocean S-Curve

```{r 0.0.3.1-viz-s-curve-monmouth, echo = F, fig.cap = "Monmouth S-Curve", out.width = '22%'}
# knitr::include_graphics(here::here("dashboard/png/", "monmouth.png"))
# test_function(dt_plt_data)
# ------------------------------------------------------------------------------
msa        <- dt.msa[id == 1,][,2]
fun_scurve_monmouth(msa)
# ------------------------------------------------------------------------------

```

### Nashville S-Curve

```{r 0.0.3.2-viz-s-curve-nashville, echo = F, fig.cap = "Nashville S-Curve", out.width = '33%'}

# ------------------------------------------------------------------------------
msa        <- dt.msa[id == 2,][,2]
fun_scurve_nashville(msa)
# ------------------------------------------------------------------------------

```

### Orlando S-Curve

```{r 0.0.3.3-viz-s-curve-orlando, echo = F, fig.cap = "Orlando S-Curve", out.width = '33%'}

# ------------------------------------------------------------------------------
msa        <- dt.msa[id == 3,][,2]
fun_scurve_orlando(msa)
# ------------------------------------------------------------------------------

```

0.1 S-Curve {data-navmenu="0-USA" data-icon="ion-cash"}
=====================================

Input {.sidebar}
-------------------------------------

```{r 0.1.0.0-sidebar-fnc}
dt_scurve <- reactive({
  dt_plt_data[brand_type == as.numeric(input$radio.0.1.0)]
})
```

```{r 0.1.0.1-sidebarInput}

dateRangeInput("dateRange.0.1.1",
  "Date Range",
  start = params$dateStart,
  end = Sys.Date(),
  min = params$dateStart,
  max = Sys.Date()
)
```

```{r 0.1.0.2-sidebarRadio}
radioButtons("radio.0.1.2", "Brand Type:",
              c("Corporate" = 1,
                "Gas" = 2,
                "Store" = 3
              )             
            )
```

```{r 0.1.0.3-sidebarRadio}
radioButtons("radio.0.1.3", "Source:",
              c("Fleet" = 1,
                "Visit Count" = 2
              ), 
              selected = "2"
            )
```

```{r 0.1.0.4-sidebar-listbox}
selectInput("date_start.0.1.4",
  label = "Start Date",
  choices = c("2022-07-02", "2021-07-03", "2017-07-01"),
  selected = "2022-07-02")
```

```{r 0.1.0.5-sidebar-checkbox}
# checkboxGroupInput("input.0.1.5",
#  label = "Year",
#  choices =  c("2022-07-02", "2021-07-03", "2017-07-01"),
#  selected = "2022-07-02")
```


Column {data-height=21%}
-------------------------------------

###

```{r 0.1.1.1-vbox-monmouth-s-curve}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Monmouth",
    color = "#004C97"
    )
  }
)
```

###

```{r 0.1.1.2-vbox-nashville-s-curve}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Nashville",
    color = "#041E42"
    )
  }
)
```

###

```{r 0.1.1.3-vbox-orlando-s-curve}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Orlando",
    color = "#fc6a03"
    )
  }
)
```

Row {data-height=200}
-------------------------------------

###

```{r 0.1.2.1-viz-s-curve-monmouth, echo = F, out.width = '33%'}
renderPlotly({
  dt_data <- data.table(
    dt_plt_data[
      msa == 1 &
      brand_type == input$radio.0.1.2 & 
      date_start == as.Date(input$date_start.0.1.4),
      ]
    )
  ggplotly(
    ggplot(,
      aes(
        x = dt_data$x,
        y = dt_data$y,
        xend = max(dt_data$x),
        yend = max(dt_data$y)),
        label = label) +
  geom_point(
    colour = dt_data$y2,
    size = 2) +
# ------------------------------------------------------------------------------
# mer slope line / s-curve boundry lines
# ------------------------------------------------------------------------------
  geom_abline(intercept = 0, slope = 1,  color = "blue", size = 0.75) +
# ------------------------------------------------------------------------------
  geom_vline(xintercept = dt_data$boundry_left,  color = "blue", size = 0.250) +
  geom_vline(xintercept = dt_data$boundry_right, color = "blue", size = 0.250) +
# ------------------------------------------------------------------------------
# shaded boundary area
# ------------------------------------------------------------------------------
  geom_rect(
    aes(xmin = dt_data$boundry_left,
        xmax = dt_data$boundry_right,
        ymin = -Inf,
        ymax = Inf),
        fill = "blue",
        colour = NA,
        alpha = 0.05)  +
# ------------------------------------------------------------------------------
# Sigmoid s-curve - Add s curve to r ggplot         https://tinyurl.com/bdfefdvh
# Step 00.02: add-s-curve-to-r-ggplot               https://tinyurl.com/bdfefdvh
# ------------------------------------------------------------------------------
  geom_sigmoid(data = dt_data,
    aes(x    = min(dt_data$x),
        xend = max(dt_data$x),
        y    = min(dt_data$y),
        yend = max(dt_data$y))) +
# ------------------------------------------------------------------------------
# label text 
# ------------------------------------------------------------------------------
  geom_text(
#    aes(label = label)) +
    aes(label = dt_data$label),
    hjust = 1.30,
    vjust = 1.00) +
# ------------------------------------------------------------------------------
# Add multiple text ranges to plot boundary
# ------------------------------------------------------------------------------
  annotate("text",
    x = (dt_data$boundry_left / 2),
    y = (max(dt_data[,6]) * 20) + .19,
    label = "GROW") +
  annotate("text",
    x = (dt_data$boundry_left + dt_data$boundry_right) / 2,
    y = (max(dt_data[,6]) * 20) + .19,
    label = "OPTIMISE") +
  annotate("text",
    x = (max(dt_data$boundry_right + max(dt_data$x)))/2,
    y = (max(dt_data[,6]) * 20) + .19,
    label = "CANNIBALISE")  +
# ------------------------------------------------------------------------------
# Title
# ------------------------------------------------------------------------------
  ggtitle(paste0(format(as.Date(input$date_start.0.1.4),"%h-%Y"), "-",
    stringr::str_to_title(dt_data$msa_name), " Market Share Saturation"),
          subtitle = format(as.Date(input$date_start.0.1.4),"%Y-%h")) +
  ggeasy::easy_center_title()  + 
# ------------------------------------------------------------------------------
# x & y axis
# ------------------------------------------------------------------------------
  labs(x = "Outlet Share", y = "Market Share")
          
      ) 
  })
```

###

```{r 0.1.2.2-viz-s-curve-nashville, echo = F, out.width = '33%'}
renderPlotly({
  dt_data <- data.table(
    dt_plt_data[
      msa == 2 &
      brand_type == input$radio.0.1.2 &
      date_start == as.Date(input$date_start.0.1.4),
    ]
  )
    ggplotly(
      ggplot(,
        aes(
          x = dt_data$x,
          y = dt_data$y,
          xend = max(dt_data$x),
          yend = max(dt_data$y)),
          label = label) +
  geom_point(
    colour = dt_data$y2,
    size = 2) +
# ------------------------------------------------------------------------------
# mer slope line / s-curve boundry lines
# ------------------------------------------------------------------------------
  geom_abline(intercept = 0, slope = 1,  color = "blue", size = 0.75) +
# ------------------------------------------------------------------------------
  geom_vline(xintercept = dt_data$boundry_left,  color = "blue", size = 0.250) +
  geom_vline(xintercept = dt_data$boundry_right, color = "blue", size = 0.250) +
# ------------------------------------------------------------------------------
# shaded boundary area
# ------------------------------------------------------------------------------
  geom_rect(
    aes(xmin = dt_data$boundry_left,
        xmax = dt_data$boundry_right,
        ymin = -Inf,
        ymax = Inf),
        fill = "blue",
        colour = NA,
        alpha = 0.05)  +
# ------------------------------------------------------------------------------
# Sigmoid s-curve - Add s curve to r ggplot         https://tinyurl.com/bdfefdvh
# Step 00.02: add-s-curve-to-r-ggplot               https://tinyurl.com/bdfefdvh
# ------------------------------------------------------------------------------
  geom_sigmoid(data = dt_data,
    aes(x    = min(dt_data$x),
        xend = max(dt_data$x),
        y    = min(dt_data$y),
        yend = max(dt_data$y))) +
# ------------------------------------------------------------------------------
# label text 
# ------------------------------------------------------------------------------
  geom_text(
#    aes(label = label)) +
    aes(label = dt_data$label),
    hjust = 1.30,
    vjust = 1.00) +
# ------------------------------------------------------------------------------
# Add multiple text ranges to plot boundary
# ------------------------------------------------------------------------------
  annotate("text",
    x = (dt_data$boundry_left / 2),
    y = (max(dt_data[,6]) * 20) + .19,
    label = "GROW") +
  annotate("text",
    x = (dt_data$boundry_left + dt_data$boundry_right) / 2,
    y = (max(dt_data[,6]) * 20) + .19,
    label = "OPTIMISE") +
  annotate("text",
    x = (max(dt_data$boundry_right + max(dt_data$x)))/2,
    y = (max(dt_data[,6]) * 20) + .19,
    label = "CANNIBALISE")  +
# ------------------------------------------------------------------------------
# Title
# ------------------------------------------------------------------------------
  ggtitle(paste0(format(as.Date(input$date_start.0.1.4),"%h-%Y"), "-",
    stringr::str_to_title(dt_data$msa_name), " Market Share Saturation"),
          subtitle = format(as.Date(input$date_start.0.1.4),"%Y-%h")) +
  ggeasy::easy_center_title()  + 
# ------------------------------------------------------------------------------
# x & y axis
# ------------------------------------------------------------------------------
  labs(x = "Outlet Share", y = "Market Share")

      ) 
  })
```

###

```{r 0.1.2.3-viz-s-curve-orlando, echo = F,  out.width = '33%'}
renderPlotly({
  dt_data <- data.table(
    dt_plt_data[
      msa == 3 &
      brand_type == input$radio.0.1.2 &
      date_start == as.Date(input$date_start.0.1.4),
    ]
  )
    ggplotly(
      ggplot(,
        aes(
          x = dt_data$x,
          y = dt_data$y,
          xend = max(dt_data$x),
          yend = max(dt_data$y)),
          label = label) +
  geom_point(
    colour = dt_data$y2,
    size = 2) +
# ------------------------------------------------------------------------------
# mer slope line / s-curve boundry lines
# ------------------------------------------------------------------------------
  geom_abline(intercept = 0, slope = 1,  color = "blue", size = 0.75) +
# ------------------------------------------------------------------------------
  geom_vline(xintercept = dt_data$boundry_left,  color = "blue", size = 0.250) +
  geom_vline(xintercept = dt_data$boundry_right, color = "blue", size = 0.250) +
# ------------------------------------------------------------------------------
# shaded boundary area
# ------------------------------------------------------------------------------
  geom_rect(
    aes(xmin = dt_data$boundry_left,
        xmax = dt_data$boundry_right,
        ymin = -Inf,
        ymax = Inf),
        fill = "blue",
        colour = NA,
        alpha = 0.05)  +
# ------------------------------------------------------------------------------
# Sigmoid s-curve - Add s curve to r ggplot         https://tinyurl.com/bdfefdvh
# Step 00.02: add-s-curve-to-r-ggplot               https://tinyurl.com/bdfefdvh
# ------------------------------------------------------------------------------
  geom_sigmoid(data = dt_data,
    aes(x    = min(dt_data$x),
        xend = max(dt_data$x),
        y    = min(dt_data$y),
        yend = max(dt_data$y))) +
# ------------------------------------------------------------------------------
# label text 
# ------------------------------------------------------------------------------
  geom_text(
#    aes(label = label)) +
    aes(label = dt_data$label),
    hjust = 1.30,
    vjust = 1.00) +
# ------------------------------------------------------------------------------
# Add multiple text ranges to plot boundary
# ------------------------------------------------------------------------------
  annotate("text",
    x = (dt_data$boundry_left / 2),
    y = (max(dt_data[,6]) * 20) + .19,
    label = "GROW") +
  annotate("text",
    x = (dt_data$boundry_left + dt_data$boundry_right) / 2,
    y = (max(dt_data[,6]) * 20) + .19,
    label = "OPTIMISE") +
  annotate("text",
    x = (max(dt_data$boundry_right + max(dt_data$x)))/2,
    y = (max(dt_data[,6]) * 20) + .19,
    label = "CANNIBALISE")  +
# ------------------------------------------------------------------------------
# Title
# ------------------------------------------------------------------------------
  ggtitle(paste0(format(as.Date(input$date_start.0.1.4),"%h-%Y"), "-",
    stringr::str_to_title(dt_data$msa_name), " Market Share Saturation"),
          subtitle = format(as.Date(input$date_start.0.1.4),"%Y-%h")) +
  ggeasy::easy_center_title()  +     
# ------------------------------------------------------------------------------
# x & y axis
# ------------------------------------------------------------------------------
  labs(x = "Outlet Share", y = "Market Share")
          
      ) 
  })
```

0.3 Sectors {data-navmenu="0-USA" data-icon="ion-cash"}
=====================================

Input {.sidebar}
-------------------------------------

```{r 0.3.0.0-sidebar-fnc}
dt_scurve <- reactive({
  dt_plt_data[brand_type == as.numeric(input$radio.0.3.0)]
})
```

```{r 0.3.0.1-sidebar-input-date-range}
dateRangeInput("dateRange.0.3.1",
  "Date Range",
  start = params$dateStart,
  end = Sys.Date(),
  min = params$dateStart,
  max = Sys.Date()
)
```

```{r 0.3.0.2-sidebar-radio-brand-type}
radioButtons("radio.0.3.2", "Brand Type:",
              c("Corporate" = 1,
                "Gas" = 2,
                "Store" = 3
              ), 
              selected = "1"
            )
```

```{r 0.3.0.3-sidebar-radio-source}
radioButtons("radio.0.3.3", "Source:",
              c("Fleet" = 1,
                "Visit Count" = 2
              ), 
              selected = "2"
            )
```

```{r 0.3.0.4-sidebar-listbox-date}
selectInput("date_start.0.3.4",
  label = "Start Date",
  choices = c("2022-07-02", "2021-07-03", "2017-07-01"),
  selected = "2022-07-02")
```

```{r 0.3.0.5-sidebar-checkbox-date}
# checkboxGroupInput("input.0.3.5",
#  label = "Year",
#  choices =  c("2022-07-02", "2021-07-03", "2017-07-01"),
#  selected = "2017-07-01")
```

```{r 0.3.0.6-sidebar-date}
#  dateInput("date1", "Date:", value = "2022-07-02")
```

Column {data-height=12%}
-------------------------------------

###

```{r 0.3.1.1-vbox-monmouth-s-curve}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Monmouth",
    color = "#004C97"
    )
  }
)
```

###

```{r 0.3.1.2-vbox-nashville-s-curve}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Nashville",
    color = "#041E42"
    )
  }
)
```

###

```{r 0.3.1.3-vbox-orlando-s-curve}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Orlando",
    color = "#fc6a03"
    )
  }
)
```

Row {data-height=44%}
-------------------------------------

### 

```{r 0.3.2.1-tbl-monmouth-sector, echo = F, out.width = '33%'}
DT::renderDataTable({
  dt_data <- data.table(
    dt_quadrant[
      msa == 1 &
      brand_type == input$radio.0.3.2 & 
      date_start == as.Date(input$date_start.0.3.4),
      ]
    )

  dt_data <- dt_data[,c(4:5,7:6,10)]
  DT::datatable(dt_data,
    rownames = FALSE,
    extensions = c("Scroller"),
    filter = 'top',
    options = list(
      dom = 'ltipr'
      ,order = list(list(0, "quadrant"))
      ,pageLength = 20
      ,scrollX = TRUE
      ,scrollY = 280
      ,scroller = TRUE)
    ) %>%
    formatDate("date_start")   %>%
    formatPercentage( c("pct_quad_cnt"),2) 
})
```

### 

```{r 0.3.2.2-tbl-nashville-sector, echo = F, out.width = '33%'}
DT::renderDataTable({
  dt_data <- data.table(
    dt_quadrant[
      msa == 2 &
      brand_type == input$radio.0.3.2 & 
      date_start == as.Date(input$date_start.0.3.4),
      ]
    )

  dt_data <- dt_data[,c(4:5,7:6,10)]
  DT::datatable(dt_data,
    rownames = FALSE,
    extensions = c("Scroller"),
    filter = 'top',
    options = list(
      dom = 'ltipr'
      ,order = list(list(0, "quadrant"))
      ,pageLength = 20
      ,scrollX = TRUE
      ,scrollY = 280
      ,scroller = TRUE)
    ) %>%
    formatDate("date_start")   %>%
    formatPercentage( c("pct_quad_cnt"),2) 
})
```

### 

```{r 0.3.2.3-tbl-orlando-sector, echo = F, out.width = '33%'}
DT::renderDataTable({
  dt_data <- data.table(
    dt_quadrant[
      msa == 3 &
      brand_type == input$radio.0.3.2 & 
      date_start == as.Date(input$date_start.0.3.4),
      ]
    )

  dt_data <- dt_data[,c(4:5,7:6,10)]
  DT::datatable(dt_data,
    rownames = FALSE,
    extensions = c("Scroller"),
    filter = 'top',
    options = list(
      dom = 'ltipr'
      ,order = list(list(0, "quadrant"))
      ,pageLength = 20
      ,scrollX = TRUE
      ,scrollY = 280
      ,scroller = TRUE)
    ) %>%
    formatDate("date_start")   %>%
    formatPercentage( c("pct_quad_cnt"),2) 
})
```

Row {data-height=44%}
-------------------------------------
### Monmouth-Ocean S-Curve

```{r 0.3.3.1-viz-s-curve-monmouth, echo = F, fig.cap = "Monmouth S-Curve", out.width = '22%'}
# knitr::include_graphics(here::here("dashboard/png/", "monmouth.png"))
# test_function(dt_plt_data)
# ------------------------------------------------------------------------------    
  renderImage({
# ------------------------------------------------------------------------------      
    brand_type <- dt.brand.type[id == input$radio.0.3.2,][,2]
    date_start <- input$date_start.0.3.4[1]
    dt_start   <- format(as.Date(input$date_start.0.3.4), format =  "%Y%m")
    msa        <- dt.msa[id == 1,][,2]    
    plt_url    <- tolower(paste0(paste("png", dt_start, msa, brand_type, sep = "_"),".png"))
# ------------------------------------------------------------------------------    
    filename <- here::here("dashboard/png",plt_url)
    list(src = filename,
        width  = 555,
        height = 416)
  }, deleteFile = FALSE)
# ------------------------------------------------------------------------------  

```

### Nashville S-Curve

```{r 0.3.3.2-viz-s-curve-nashville, echo = F, fig.cap = "Nashvile S-Curve", out.width = '22%'}
# knitr::include_graphics(here::here("dashboard/png/", "monmouth.png"))
# test_function(dt_plt_data)
# ------------------------------------------------------------------------------    
  renderImage({
# ------------------------------------------------------------------------------      
    brand_type <- dt.brand.type[id == input$radio.0.3.2,][,2]
    date_start <- input$date_start.0.3.4[1]
    dt_start   <- format(as.Date(input$date_start.0.3.4), format =  "%Y%m")
    msa        <- dt.msa[id == 2,][,2]    
    plt_url    <- tolower(paste0(paste("png", dt_start, msa, brand_type, sep = "_"),".png"))
# ------------------------------------------------------------------------------    
    filename <- here::here("dashboard/png",plt_url)
    list(src = filename,
        width  = 555,
        height = 416)
  }, deleteFile = FALSE)
# ------------------------------------------------------------------------------  

```

### Orlando S-Curve

```{r 0.3.3.3-viz-s-curve-orlando, echo = F, fig.cap = "Orlando S-Curve", out.width = '22%'}
# knitr::include_graphics(here::here("dashboard/png/", "monmouth.png"))
# test_function(dt_plt_data)
# ------------------------------------------------------------------------------
 renderImage({
# ------------------------------------------------------------------------------      
    brand_type <- dt.brand.type[id == input$radio.0.3.2,][,2]
    date_start <- input$date_start.0.3.4[1]
    dt_start   <- format(as.Date(input$date_start.0.3.4), format =  "%Y%m")
    msa        <- dt.msa[id == 3,][,2]    
    plt_url    <- tolower(paste0(paste("png", dt_start, msa, brand_type, sep = "_"),".png"))
# ------------------------------------------------------------------------------    
    filename <- here::here("dashboard/png",plt_url)
    list(src = filename,
        width  = 555,
        height = 416)
  }, deleteFile = FALSE)
# ------------------------------------------------------------------------------

```

0.4 Animation-States {data-navmenu="0-USA" data-icon="ion-cash"}
=====================================

Input {.sidebar}
-------------------------------------

```{r 0.4.0.0-sidebar-fnc}
dt_scurve <- reactive({
  dt_plt_data[brand_type == as.numeric(input$radio.0.4.0)]
})
```

```{r 0.4.0.1-sidebar-input-date-range}
dateRangeInput("dateRange.0.4.1",
  "Date Range",
  start = params$dateStart,
  end = Sys.Date(),
  min = params$dateStart,
  max = Sys.Date()
)
```

```{r 0.4.0.2-sidebar-radio-brand-type}
radioButtons("radio.0.4.2", "Brand Type:",
              c("Corporate" = 1,
                "Gas" = 2,
                "Store" = 3
              ), 
              selected = "1"
            )
```

```{r 0.4.0.3-sidebar-radio-source}
radioButtons("radio.0.4.3", "Source:",
              c("Fleet" = 1,
                "Visit Count" = 2
              ), 
              selected = "2"
            )
```
```{r 0.4.0.4-sidebar-listbox-date}
selectInput("date_start.0.4.4",
  label = "Start Date",
  choices = c("2022-07-02", "2021-07-03", "2017-07-01"),
  selected = "2022-07-02")
```

```{r 0.4.0.5-sidebar-checkbox-date}
# checkboxGroupInput("input.0.4.5",
#  label = "Year",
#  choices =  c("2022-07-02", "2021-07-03", "2017-07-01"),
#  selected = "2017-07-01")
```

```{r 0.4.0.6-sidebar-date}
#  dateInput("date1", "Date:", value = "2022-07-02")
```

Column {data-height=12%}
-------------------------------------

###

```{r 0.4.1.1-vbox-monmouth-s-curve}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Monmouth-Corporate Fleet",
    color = "#004C97"
    )
  }
)
```

###

```{r 0.4.1.2-vbox-nashville-s-curve}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Monmouth-Store Fleet",
    color = "#004C97"
    )
  }
)
```


Row {data-height=88%}
-------------------------------------
### Monmouth-Ocean Corporate Fleet

```{r 0.4.2.1-anim-s-curve-monmouth, echo = F, fig.cap = "Monmouth S-Curve", out.width = '100%', out.height = '100%'}

# knitr::include_graphics(here::here("dashboard/anim/", "nsh_trans_states_int_date_length_3_state_1_quadratic_fps_010_0525x0700_res_095_end_pause_010_duration_066.gif"))
# knitr::include_graphics(here::here("dashboard/anim/", "nsh_trans_states_int_date_length_3_state_1_quadratic_shadow_trail_max_03_fps_010_1280x0720_res_100_end_pause_005_duration_066.gif"))
# knitr::include_graphics(here::here("dashboard/anim/", "manual_cube_trail_1024x768_res_100_end_003_duration_033.gif"))
# knitr::include_graphics(here::here("dashboard/anim/", "states_length_03_state_01_quadratic_trail_003_fps_010_end_pause_005_duration_066.gif"))
knitr::include_graphics(here::here("dashboard/anim/s-curve/", "monmouth-ocean_corporate_fleet.gif"))

```

### Monmouth-Ocean Store Fleet

```{r 0.4.2.2-anim-s-curve-nashville, echo = F, fig.cap = "Nashvile S-Curve", out.width = '100%'}

  # knitr::include_graphics(here::here("dashboard/anim/", "nsh_trans_states_int_date_length_03_state_01_ease_quadratic_shadow_wake_0.05_fps_010_0600x0800_res_100_end_pause_005_duration_066.gif"))

  knitr::include_graphics(here::here("dashboard/anim/s-curve", "monmouth-ocean_store_fleet.gif"))

```

0.5 Animation {data-navmenu="0-USA" data-icon="ion-cash"}
=====================================

Input {.sidebar}
-------------------------------------

```{r 0.5.0.0-sidebar-fnc}
dt_scurve <- reactive({
  dt_plt_data[brand_type == as.numeric(input$radio.0.5.0)]
})
```

```{r 0.5.0.1-sidebar-input-date-range}
dateRangeInput("dateRange.0.5.1",
  "Date Range",
  start = params$dateStart,
  end = Sys.Date(),
  min = params$dateStart,
  max = Sys.Date()
)
```

```{r 0.5.0.2-sidebar-radio-brand-type}
radioButtons("radio.0.5.2", "Brand Type:",
              c("Corporate" = 1,
                "Gas" = 2,
                "Store" = 3
              ), 
              selected = "1"
            )
```

```{r 0.5.0.3-sidebar-radio-source}
radioButtons("radio.0.5.3", "Source:",
              c("Fleet" = 1,
                "Visit Count" = 2
              ), 
              selected = "2"
            )
```
```{r 0.5.0.4-sidebar-listbox-date}
selectInput("date_start.0.5.4",
  label = "Start Date",
  choices = c("2022-07-02", "2021-07-03", "2017-07-01"),
  selected = "2022-07-02")
```

```{r 0.5.0.5-sidebar-checkbox-date}
# checkboxGroupInput("input.0.5.5",
#  label = "Year",
#  choices =  c("2022-07-02", "2021-07-03", "2017-07-01"),
#  selected = "2017-07-01")
```

```{r 0.5.0.6-sidebar-date}
#  dateInput("date1", "Date:", value = "2022-07-02")
```

Column {data-height=12%}
-------------------------------------


###

```{r 0.5.1.2-vbox-nashville}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Nashville",
    color = "#041E42"
    )
  }
)
```

###

```{r 0.5.1.3-vbox-orlando}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Orlando",
    color = "#fc6a03"
    )
  }
)
```

Row {data-height=88%}
-------------------------------------
### Nashville Fleet by Corporate Brand

```{r 0.5.2.1-anim-s-curve-nashville, echo = F, fig.cap = "Nashville S-Curve", dpi = 200, out.width = '100%', out.height = '200%'}

#  knitr::include_graphics(here::here("dashboard/anim/", "manual_cube_trail_1024x768_res_100_end_003_duration_033.gif"))
knitr::include_graphics(here::here("dashboard/anim/", "nsh_corp_state_03_01_quad_trail_003_nf_375_0800x600_res_100_end_005.gif"))
```

### Orlando Fleet by Corporate Brand

```{r 0.5.2.2-anim-s-curve-orlando, echo = F, fig.cap = "Orlando S-Curve", dpi = 72, out.width = '100%'}

#  knitr::include_graphics(here::here("dashboard/anim/", "nsh_trans_manual_int_date_ease_aes_quadratic_nfames_0250_fps_15_0600x0800_res_100_end_pause_3.gif"))
knitr::include_graphics(here::here("dashboard/anim/", "orl_corp_state_03_01_quad_trail_003_nf_375_0800x600_res_100_end_005.gif"))

```

0.6 Animation-Sector {data-navmenu="0-USA" data-icon="ion-cash"}
=====================================

Input {.sidebar}
-------------------------------------

```{r 0.6.0.0-sidebar-fnc}
dt_scurve <- reactive({
  dt_plt_data[brand_type == as.numeric(input$radio.0.6.0)]
})
```

```{r 0.6.0.1-sidebar-input-date-range}
dateRangeInput("dateRange.0.6.1",
  "Date Range",
  start = params$dateStart,
  end = Sys.Date(),
  min = params$dateStart,
  max = Sys.Date()
)
```

```{r 0.6.0.2-sidebar-radio-brand-type}
radioButtons("radio.0.6.2", "Brand Type:",
              c("Corporate" = 1,
                "Gas" = 2,
                "Store" = 3
              ), 
              selected = "1"
            )
```

```{r 0.6.0.3-sidebar-radio-source}
radioButtons("radio.0.6.3", "Source:",
              c("Fleet" = 1,
                "Visit Count" = 2
              ), 
              selected = "2"
            )
```
```{r 0.6.0.4-sidebar-listbox-date}
selectInput("date_start.0.6.4",
  label = "Start Date",
  choices = c("2022-07-02", "2021-07-03", "2017-07-01"),
  selected = "2022-07-02")
```

```{r 0.6.0.5-sidebar-checkbox-date}
# checkboxGroupInput("input.0.6.5",
#  label = "Year",
#  choices =  c("2022-07-02", "2021-07-03", "2017-07-01"),
#  selected = "2017-07-01")
```

```{r 0.6.0.6-sidebar-date}
#  dateInput("date1", "Date:", value = "2022-07-02")
```

Column {data-height=12%}
-------------------------------------

###

```{r 0.6.1.1.a-vbox-monmouth}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Monmouth",
    color = "#004C97"
    )
  }
)
```

###

```{r 0.6.1.2-vbox-nashville}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Nashville",
    color = "#041E42"
    )
  }
)
```

###

```{r 0.6.1.3-vbox-orlando}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Orlando",
    color = "#fc6a03"
    )
  }
)
```

Row {data-height=88%}
-------------------------------------

### MSA Sectors by Corporate Brand

```{r 0.6.2.1-anim-tbl-sector-brand, echo = F, fig.cap = "Nashvile S-Curve", out.width = '100%', out.height = '100%'}

#  knitr::include_graphics(here::here("dashboard/anim/", "nsh_trans_manual_int_date_nfames_1000.gif"))
knitr::include_graphics(here::here("dashboard/anim/quad", "msa_sectors_corp_432x48_720x500_res_100.gif"))

```

###  MSA Sectors by Store Brand

```{r 0.6.2.2-anim-tbl-sector-store, echo = F, fig.cap = "Orlando S-Curve", out.width = '100%', out.height = '100%'}
#  knitr::include_graphics(here::here("dashboard/anim/", "nsh_450x600_5_fps_duration_99_trans_state_int_date_shadow_mark_ease_quad_in_out.gif"))
knitr::include_graphics(here::here("dashboard/anim/quad", "msa_quad_store_432x48_720x500_res_100.gif"))

```

0.7 Animation-Sector {data-navmenu="0-USA" data-icon="ion-cash"}
=====================================

Input {.sidebar}
-------------------------------------

```{r 0.7.0.0-sidebar-fnc}
dt_scurve <- reactive({
  dt_plt_data[brand_type == as.numeric(input$radio.0.7.0)]
})
```

```{r 0.7.0.1-sidebar-input-date-range}
dateRangeInput("dateRange.0.7.1",
  "Date Range",
  start = params$dateStart,
  end = Sys.Date(),
  min = params$dateStart,
  max = Sys.Date()
)
```

```{r 0.7.0.2-sidebar-radio-brand-type}
radioButtons("radio.0.7.2", "Brand Type:",
              c("Corporate" = 1,
                "Gas" = 2,
                "Store" = 3
              ), 
              selected = "1"
            )
```

```{r 0.7.0.3-sidebar-radio-source}
radioButtons("radio.0.7.3", "Source:",
              c("Fleet" = 1,
                "Visit Count" = 2
              ), 
              selected = "2"
            )
```

```{r 0.7.0.4-sidebar-listbox-date}
selectInput("date_start.0.7.4",
  label = "Start Date",
  choices = c("2022-07-02", "2021-07-03", "2017-07-01"),
  selected = "2022-07-02")
```

```{r 0.7.0.5-sidebar-checkbox-date}
# checkboxGroupInput("input.0.7.5",
#  label = "Year",
#  choices =  c("2022-07-02", "2021-07-03", "2017-07-01"),
#  selected = "2017-07-01")
```

```{r 0.7.0.6-sidebar-date}
#  dateInput("date1", "Date:", value = "2022-07-02")
```

Column {data-height=9%}
-------------------------------------

###

```{r 0.7.1.1.a-vbox-sector-01}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Sector 01",
    color = "#004C97"
    )
  }
)
```

###

```{r 0.7.1.2-vbox-sector-02}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Sector 02",
    color = "#041E42"
    )
  }
)
```

###

```{r 0.7.1.3-vbox-sector-03}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Sector 03",
    color = "#fc6a03"
    )
  }
)
```

Row {data-height=41%}
-------------------------------------

### 

```{r 0.7.2.1-anim-line-msa-sector-01, echo = F}

  renderImage({
# ------------------------------------------------------------------------------      
    brand_type <- dt.brand.type[id == input$radio.0.7.2,][,2]
    # date_start <- input$date_start.0.3.4[1]
    # dt_start   <- format(as.Date(input$date_start.0.3.4), format =  "%Y%m")
    # msa        <- dt.msa[id == 1,][,2]    
    plt_url    <- tolower(paste0(brand_type, "_sector_01_by_yr.gif"))
# ------------------------------------------------------------------------------    
    filename <- here::here("dashboard/anim/sector", plt_url)
    list(src = filename,
        width  = 640,
        height = 360)
  }, deleteFile = FALSE)

```

### 

```{r 0.7.2.2-anim-line-msa-sector-02, echo = F}

  renderImage({
# ------------------------------------------------------------------------------      
    brand_type <- dt.brand.type[id == input$radio.0.7.2,][,2]
    # date_start <- input$date_start.0.3.4[1]
    # dt_start   <- format(as.Date(input$date_start.0.3.4), format =  "%Y%m")
    # msa        <- dt.msa[id == 1,][,2]    
    plt_url    <- tolower(paste0(brand_type, "_sector_02_by_yr.gif"))
# ------------------------------------------------------------------------------    
    filename <- here::here("dashboard/anim/sector", plt_url)
    list(src = filename,
        width  = 640,
        height = 360)
  }, deleteFile = FALSE)

```

### 

```{r 0.7.2.3-anim-line-msa-sector-03, echo = F}

  renderImage({
# ------------------------------------------------------------------------------      
    brand_type <- dt.brand.type[id == input$radio.0.7.2,][,2]
    # date_start <- input$date_start.0.3.4[1]
    # dt_start   <- format(as.Date(input$date_start.0.3.4), format =  "%Y%m")
    # msa        <- dt.msa[id == 1,][,2]    
    plt_url    <- tolower(paste0(brand_type, "_sector_03_by_yr.gif"))
# ------------------------------------------------------------------------------    
    filename <- here::here("dashboard/anim/sector", plt_url)
    list(src = filename,
        width  = 640,
        height = 360)
  }, deleteFile = FALSE)

```

Column {data-height=9%}
-------------------------------------

###

```{r 0.7.3.1.a-vbox-sector-04}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Sector 04",
    color = "#004C97"
    )
  }
)
```

###

```{r 0.7.3.2-vbox-sector-05}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Sector 05",
    color = "#041E42"
    )
  }
)
```

###

```{r 0.7.3.3-vbox-sector-06}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Sector 06",
    color = "#fc6a03"
    )
  }
)
```

Row {data-height=41%}
-------------------------------------
###

```{r 0.7.4.1-anim-line-msa-sector-04, echo = F}

  renderImage({
# ------------------------------------------------------------------------------      
    brand_type <- dt.brand.type[id == input$radio.0.7.2,][,2]
    # date_start <- input$date_start.0.3.4[1]
    # dt_start   <- format(as.Date(input$date_start.0.3.4), format =  "%Y%m")
    # msa        <- dt.msa[id == 1,][,2]    
    plt_url    <- tolower(paste0(brand_type, "_sector_04_by_yr.gif"))
# ------------------------------------------------------------------------------    
    filename <- here::here("dashboard/anim/sector", plt_url)
    list(src = filename,
        width  = 640,
        height = 360)
  }, deleteFile = FALSE)

```

### 

```{r 0.7.4.2-anim-line-msa-sector-05, echo = F}

  renderImage({
# ------------------------------------------------------------------------------      
    brand_type <- dt.brand.type[id == input$radio.0.7.2,][,2]
    # date_start <- input$date_start.0.3.4[1]
    # dt_start   <- format(as.Date(input$date_start.0.3.4), format =  "%Y%m")
    # msa        <- dt.msa[id == 1,][,2]    
    plt_url    <- tolower(paste0(brand_type, "_sector_05_by_yr.gif"))
# ------------------------------------------------------------------------------    
    filename <- here::here("dashboard/anim/sector", plt_url)
    list(src = filename,
        width  = 640,
        height = 360)
  }, deleteFile = FALSE)

```

### 

```{r 0.7.4.3-anim-line-msa-sector-06, echo = F}

  renderImage({
# ------------------------------------------------------------------------------      
    brand_type <- dt.brand.type[id == input$radio.0.7.2,][,2]
    # date_start <- input$date_start.0.3.4[1]
    # dt_start   <- format(as.Date(input$date_start.0.3.4), format =  "%Y%m")
    # msa        <- dt.msa[id == 1,][,2]    
    plt_url    <- tolower(paste0(brand_type, "_sector_06_by_yr.gif"))
# ------------------------------------------------------------------------------    
    filename <- here::here("dashboard/anim/sector", plt_url)
    list(src = filename,
        width  = 640,
        height = 360)
  }, deleteFile = FALSE)

```

0.8 Animation-Sector {data-navmenu="0-USA" data-icon="ion-cash"}
=====================================

Input {.sidebar}
-------------------------------------

```{r 0.8.0.0-sidebar-fnc}
dt_scurve <- reactive({
  dt_plt_data[brand_type == as.numeric(input$radio.0.8.0)]
})
```

```{r 0.8.0.1-sidebar-input-date-range}
dateRangeInput("dateRange.0.8.1",
  "Date Range",
  start = params$dateStart,
  end = Sys.Date(),
  min = params$dateStart,
  max = Sys.Date()
)
```

```{r 0.8.0.2-sidebar-radio-brand-type}
radioButtons("radio.0.8.2", "Brand Type:",
              c("Corporate" = 1,
                "Gas" = 2,
                "Store" = 3
              ), 
              selected = "1"
            )
```

```{r 0.8.0.3-sidebar-radio-source}
radioButtons("radio.0.8.3", "Source:",
              c("Fleet" = 1,
                "Visit Count" = 2
              ), 
              selected = "2"
            )
```
```{r 0.8.0.4-sidebar-listbox-date}
selectInput("date_start.0.8.4",
  label = "Start Date",
  choices = c("2022-07-02", "2021-07-03", "2017-07-01"),
  selected = "2022-07-02")
```

```{r 0.8.0.5-sidebar-checkbox-date}
# checkboxGroupInput("input.0.8.5",
#  label = "Year",
#  choices =  c("2022-07-02", "2021-07-03", "2017-07-01"),
#  selected = "2017-07-01")
```

```{r 0.8.0.6-sidebar-date}
#  dateInput("date1", "Date:", value = "2022-07-02")
```

Column {data-height=12%}
-------------------------------------

###

```{r 0.8.1.1-vbox-usa-sector-pct}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "USA Sector Percentage",
    color = "#004C97"
    )
  }
)
```


Row {data-height=88%}
-------------------------------------
###

```{r 0.8.2.1-anim-hbar-usa-sector-pct, echo = F, fig.cap = "USA-Sector Pct", out.width = '100%', out.height = '100%'}

# knitr::include_graphics(here::here("dashboard/anim/", "nsh_trans_states_int_date_length_3_state_1_quadratic_fps_010_0525x0700_res_095_end_pause_010_duration_066.gif"))
# knitr::include_graphics(here::here("dashboard/anim/", "nsh_trans_states_int_date_length_3_state_1_quadratic_shadow_trail_max_03_fps_010_1280x0720_res_100_end_pause_005_duration_066.gif"))
# knitr::include_graphics(here::here("dashboard/anim/", "manual_cube_trail_1024x768_res_100_end_003_duration_033.gif"))
knitr::include_graphics(here::here("dashboard/anim/sector", "msa_sector_pct_by_yr.gif"))

```

###

```{r 0.8.2.2-anim-vbar-usa-sector-pct, echo = F, fig.cap = "USA-Sector Pct", out.width = '100%'}

  # knitr::include_graphics(here::here("dashboard/anim/", "nsh_trans_states_int_date_length_03_state_01_ease_quadratic_shadow_wake_0.05_fps_010_0600x0800_res_100_end_pause_005_duration_066.gif"))

  knitr::include_graphics(here::here("dashboard/anim/sector", "usa_sector_pct_by_yr.gif"))

```

1.0 Monmouth {data-navmenu="1-Monmouth" data-icon="fa-list"}
=====================================

Input {.sidebar}
-------------------------------------

```{r 1.0.0.0-sidebar-fnc}
dt_scurve <- reactive({
  dt_plt_data[brand_type == as.numeric(input$radio.1.0.2)]
})
```

```{r 1.0.0.1-sidebarInput}
# dateRangeInput("dateRange.1.1",
#  "Date Range",
#  start = params$dateStart,
#  end = Sys.Date(),
#  min = params$dateStart,
#  max = Sys.Date()
# )
```

```{r 1.0.0.2-sidebarRadio}
radioButtons("radio.1.0.2", "Brand Type:",
              c("Corporate" = 1,
                "Gas" = 2,
                "Store" = 3
              )
            )
```

```{r 1.0.0.3-sidebarRadio}
radioButtons("radio.1.0.3", "Source:",
              c("Fleet" = 1,
                "Visit Count" = 2
              ),
              selected = "2"
            )
```

```{r 1.0.0.4-sidebar-listbox}
selectInput("date_start.1.0.4",
  label = "Start Date",
  choices = c("2022-07-02", "2021-07-03", "2017-07-01"),
  selected = "2022-07-02")
```

```{r 1.0.0.5-sidebar-date}
dateInput("date_start.1.0.5", "Start Date:", value = "2022-07-02")
```

Column {data-height=12%}
-------------------------------------

###

```{r 1.0.1.1-vbox-legend}
flexdashboard::renderValueBox(
  {
    brand_type <- dt.brand.type[id == input$radio.1.0.2,][,2]
    flexdashboard::valueBox(
    paste0("Monmouth-",  stringr::str_to_title(brand_type)),
    color = "#004C97"
    )
  }
)
```

###

```{r 1.0.1.2-vbox-max-outlet-share}

flexdashboard::renderValueBox(
  {
# ------------------------------------------------------------------------------    
    maxOutlets <- max(dt.mkt.share[msa == 1 & brand_type == as.numeric(input$radio.1.0.2), 5])
# ------------------------------------------------------------------------------
    flexdashboard::valueBox(
      paste0("Max Outlets: ", as.character(maxOutlets)),
      color = "#004C97"
    )
# ------------------------------------------------------------------------------  
  }
)
```

###

```{r 1.0.1.3.a-vbox-max-outlet-share-pct}

flexdashboard::renderValueBox(
  {
# ------------------------------------------------------------------------------    
    maxOutletShare <- percent(max(dt.mkt.share[msa == 1 & brand_type == as.numeric(input$radio.1.0.2), 7]))
# ------------------------------------------------------------------------------
    flexdashboard::valueBox(
      paste0("Max Outlet Share: ", as.character(maxOutletShare)),
      color = "#004C97"
    )
# ------------------------------------------------------------------------------  
  }
)
```

###

```{r 1.0.1.4-vbox-max-market-share-pct}

flexdashboard::renderValueBox(
  {
# ------------------------------------------------------------------------------    
    maxMarketShare <- percent(max(dt.mkt.share[msa == 1 & brand_type == as.numeric(input$radio.1.0.2), 6]))
# ------------------------------------------------------------------------------
    flexdashboard::valueBox(
      paste0("Max Mkt Share: ", as.character(maxMarketShare)),
      color = "#004C97"
    )
# ------------------------------------------------------------------------------  
  }
)
```

###

```{r 1.0.1.5-vbox-max-mer-pct}

flexdashboard::renderValueBox(
  {
# ------------------------------------------------------------------------------    
    maxMER <- sprintf(max(dt.mkt.share[msa == 1 & brand_type == as.numeric(input$radio.1.0.2), 8]), fmt = '%#.2f')
# ------------------------------------------------------------------------------
    flexdashboard::valueBox(
      paste0("Max MER: ", as.character(maxMER)),
      color = "#004C97"
    )
# ------------------------------------------------------------------------------  
  }

)
```

Row {data-height=44%, .tabset .tabset-fade}
-------------------------------------

### Monmouth-Ocean Market Share

```{r 1.0.2.1-table-mkt-share}
DT::renderDataTable({
  ind     <- as.numeric(input$radio.1.0.2)
  dt_data <- data.table(dt.mkt.share[brand_type == ind, ])
  dt_data <- dt_data[msa == 1, c(11,16,19,4:5,7:6,8:9)]
  DT::datatable(dt_data,
    rownames = FALSE,
    extensions = c("Scroller"),
    filter = 'top',
    options = list(
      dom = 'ltipr'
      ,order = list(list(0, "desc"))
      ,pageLength = 20
      ,scrollX = TRUE
      ,scrollY = 280
      ,scroller = TRUE)
    ) %>%
    formatDate(c("date_start")
    ) %>%
    formatRound("outlets", 0
    ) %>%
    formatStyle("outlets",
      background = styleColorBar(range(dt.mkt.share$outlets), "#004C97"),
        color = "white"
    ) %>%    
    formatPercentage( c("mkt_share_pct", "outlet_share_pct"),2) %>%
    formatStyle("outlet_share_pct",
      background = styleColorBar(range(dt.mkt.share$outlet_share_pct), "#004C97"),
      color = "#FFFFFF"
    ) %>%
    formatStyle("mkt_share_pct",
      background = styleColorBar(range(dt.mkt.share$mkt_share_pct), "#004C97"),
      color = "white"
    )  %>%
    formatRound("mer", 2) %>%
    formatStyle("mer",
      background = styleColorBar(range(dt.mkt.share$mer), "#004C97"),
      color = "white"
    ) 
})
```

### MER

```{r 1.0.2.2-viz-box-mer, eval=dt.mkt.share}

renderPlotly({
# ------------------------------------------------------------------------------
    dt.mkt.share    <- 
      data.table(
        dt.mkt.share[
          msa        == 1          
#          msa        == 1 &
#          brand_type == 1,        
#         brand_type == input$radio.1.0.2 &
#         date_start == as.Date("2022-07-02"),
      ]
    )  
# ------------------------------------------------------------------------------
    dt_monmouth    <- data.table(
      dt.mkt.share[
        msa        == 1 &
        brand_type == 1 
#       date_start == input$date_start.1.0.5,
#       date_start == format(input$date_start.1.0.4),
#       date_start == as.character(format(as.Date(input$date_start.1.0.4)))
#        date_start == as.Date("2022-07-02"),
      ]
    )
# ------------------------------------------------------------------------------
    dt_nashville    <- data.table(
      dt.mkt.share[
        msa        == 1 &
        brand_type == 2
#        date_start == format(as.Date("2022-07-02")),
      ]
    )
# ------------------------------------------------------------------------------
    dt_orlando    <- data.table(
      dt.mkt.share[
        msa        == 1 &
        brand_type == 3 
#        date_start == as.Date("2022-07-02"),
      ]
    )
# ------------------------------------------------------------------------------
  p <- plot_ly(type = "box") %>%
# ------------------------------------------------------------------------------  
      add_boxplot(
        x = dt.mkt.share,
        y = dt.mkt.share$mer,
          jitter    = 0.3,
          pointpos  = -1.8,
          boxpoints = "all",
        marker      = list(color = "rgb(7,40,89)"),
        line        = list(color = "rgb(7,40,89)"),
        name        = "Monmouth"
    ) %>%  
# ------------------------------------------------------------------------------  
      add_boxplot(
        x = dt_monmouth,
        y = dt_monmouth$mer, 
          jitter    = 0.3,
          pointpos  = -1.8,
          boxpoints = "all",
        marker      = list(color = "rgb(7,40,89)"),
        line        = list(color = "rgb(7,40,89)"),
        name        = "Corporate"
    ) %>%
# ------------------------------------------------------------------------------    
      add_boxplot(
        x = dt_nashville,
        y = dt_nashville$mer, 
          jitter    = 0.3,
          pointpos  = -1.8,
          boxpoints = "all",
        marker      = list(color = "rgb(7,40,89)"),
        line        = list(color = "rgb(7,40,89)"),
        name        = "Gas"
    ) %>%
# ------------------------------------------------------------------------------    
      add_boxplot(
        x = dt_orlando,
        y = dt_orlando$mer, 
          jitter    = 0.3,
          pointpos  = -1.8,
          boxpoints = "all",
        marker      = list(color = "rgb(7,40,89)"),
        line        = list(color = "rgb(7,40,89)"),
        name        = "Store"
    ) %>%    
# ------------------------------------------------------------------------------    
    layout(title = "MSA MER",
      yaxis = list(
      title = '-MER')
    )
  }
)
```

### Anime

```{r 1.0.2.3-gif-anime-msa, eval=dt.mkt.share}

# knitr::include_graphics(here::here("dashboard/gif/", "mon_corp.gif"))

```

Row {data-height=44%}
-------------------------------------

### 2022

```{r 1.0.3.1-viz-s-curve-monmouth, echo = F, fig.cap = "", out.width = '33%'}
# knitr::include_graphics(here::here("dashboard/png/", "monmouth.png"))
# ------------------------------------------------------------------------------    
 renderImage({
# ------------------------------------------------------------------------------      
    brand_type <- dt.brand.type[id == input$radio.1.0.2,][,2]
    date_start <- input$date_start.0.0.4[2]    
  #  dt_start   <- format(as.Date(input$date_start.0.0.4), format =  "%Y%m")
    dt_start   <- format(dt.date[1,2], "%Y%m")
    msa        <- dt.msa[id == 1,][,2]
    plt_url    <- tolower(paste0(paste("png", dt_start, msa, brand_type, sep = "_"),".png"))
# ------------------------------------------------------------------------------    
    filename <- here::here("dashboard/png",plt_url)
    list(src    = filename,
        width  = 555,
        height = 416)
  }, deleteFile = FALSE)
# ------------------------------------------------------------------------------  

```

### 2021

```{r 1.0.3.2-viz-s-curve-nashville, echo = F, fig.cap = "", out.width = '33%'}
# knitr::include_graphics(here::here("dashboard/png/", "nashville.png"))
# ------------------------------------------------------------------------------    
 renderImage({
# ------------------------------------------------------------------------------      
    brand_type <- dt.brand.type[id == input$radio.1.0.2,][,2]
    date_start <- input$date_start.0.0.4[2]    
#    dt_start   <- format(as.Date(input$date_start.0.0.4), format =  "%Y%m")
    dt_start   <- format(dt.date[2,2], "%Y%m")
    msa        <- dt.msa[id == 1,][,2]
    plt_url    <- tolower(paste0(paste("png", dt_start, msa, brand_type, sep = "_"),".png"))
# ------------------------------------------------------------------------------    
    filename <- here::here("dashboard/png",plt_url)
    list(src    = filename,
        width  = 555,
        height = 416)
  }, deleteFile = FALSE)
# ------------------------------------------------------------------------------  

```

### 2017

```{r 1.0.3.3-viz-s-curve-orlando, echo = F, fig.cap = "Orlando S-Curve", out.width = '33%'}
# knitr::include_graphics(here::here("dashboard/png/", "orlando.png"))
# ------------------------------------------------------------------------------    
 renderImage({
# ------------------------------------------------------------------------------      
    brand_type <- dt.brand.type[id == input$radio.1.0.2,][,2]
    date_start <- input$date_start.0.0.4[2]    
#    dt_start   <- format(as.Date(input$date_start.0.0.4), format =  "%Y%m")
    dt_start   <- format(dt.date[3,2], "%Y%m")
    msa        <- dt.msa[id == 1,][,2]
    plt_url    <- tolower(paste0(paste("png", dt_start, msa, brand_type, sep = "_"),".png"))
# ------------------------------------------------------------------------------    
    filename <- here::here("dashboard/png",plt_url)
    list(src    = filename,
        width  = 555,
        height = 416)
  }, deleteFile = FALSE)
# ------------------------------------------------------------------------------  

```

1.1 S-Curve {data-navmenu="1-Monmouth" data-icon="ion-cash"}
=====================================

Input {.sidebar}
-------------------------------------

```{r 1.1.0.0-sidebar-fnc}
dt_scurve <- reactive({
  dt_plt_data[brand_type == as.numeric(input$radio.1.1.0)]
})
```

```{r 1.1.0.1-sidebarInput}
dateRangeInput("dateRange.1.1.1",
  "Date Range",
  start = params$dateStart,
  end = Sys.Date(),
  min = params$dateStart,
  max = Sys.Date()
)
```

```{r 1.1.0.2-sidebarRadio}
radioButtons("radio.1.1.2", "Brand Type:",
              c("Corporate" = 1,
                "Gas" = 2,
                "Store" = 3
                ), 
              selected = "1"
            )
```

```{r 1.1.0.3-sidebarRadio}
radioButtons("radio.1.1.3", "Source:",
              c("Fleet" = 1,
                "Visit Count" = 2
                ), 
              selected = "2"
            )
```

```{r 1.1.0.4-sidebar-listbox}
selectInput("input.1.1.4",
  label = "Start Date",
  choices = c("2022-07-02", "2021-07-03", "2017-07-01"),
  selected = "2021-07-03")
```

```{r 1.1.0.5-sidebar-checkbox}
checkboxGroupInput("input.1.1.5",
  label = "Year",
  choices =  as.list(as.character(unique(dt.date[,2]))),
#  choices =  c("2022-07-02", "2021-07-03", "2017-07-01"),
  selected = "2021-07-03")
```

```{r 1.1.0.6-sidebar-checkbox}
checkboxGroupInput(
  inputId      = "input.1.1.0.6",
  label        = "Year",
  choiceNames  =
    list(icon("calendar"), icon("bed"),
    icon("cog"), icon("bug")),
  choiceValues =
    list("calendar", "bed", "cog", "bug"),
  selected     = "cog")
```

Column {data-height=21%}
-------------------------------------

###

```{r 1.1.1.1-vbox-monmouth-s-curve}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Monmouth  July 2022",
    color = "#004C97"
    )
  }
)
```

###

```{r 1.1.1.2-vbox-nashville-s-curve}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Monmouth July 2021",
    color = "#004C97"
    )
  }
)
```

###

```{r 1.1.1.3-vbox-orlando-s-curve}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Monmouth 2017",
    color = "#004C97"
    )
  }
)
```

Row {data-height=200}
-------------------------------------

###

```{r 1.1.2.1-viz-s-curve-monmouth, echo = F, fig.cap='xxxx', out.width = '33%'}

renderPlotly({
  dt_data <- data.table(
    dt_plt_data[
      msa == 1 &
      brand_type == input$radio.1.1.2 & 
      date_start == as.Date("2022-07-02"),
#      date_start == as.Date(input$date_start.1.1.4),
      ]
    )
  ggplotly(
    ggplot(,
      aes(
        x = dt_data$x,
        y = dt_data$y,
        xend = max(dt_data$x),
        yend = max(dt_data$y)),
        label = label) +
  geom_point(
    colour = dt_data$y2,
    size = 2) +
# ------------------------------------------------------------------------------
# mer slope line / s-curve boundry lines
# ------------------------------------------------------------------------------
  geom_abline(intercept = 0, slope = 1,  color = "blue", size = 0.75) +
# ------------------------------------------------------------------------------
  geom_vline(xintercept = dt_data$boundry_left,  color = "blue", size = 0.250) +
  geom_vline(xintercept = dt_data$boundry_right, color = "blue", size = 0.250) +
# ------------------------------------------------------------------------------
# shaded boundary area
# ------------------------------------------------------------------------------
  geom_rect(
    aes(xmin = dt_data$boundry_left,
        xmax = dt_data$boundry_right,
        ymin = -Inf,
        ymax = Inf),
        fill = "blue",
        colour = NA,
        alpha = 0.05)  +
# ------------------------------------------------------------------------------
# Sigmoid s-curve - Add s curve to r ggplot         https://tinyurl.com/bdfefdvh
# Step 00.02: add-s-curve-to-r-ggplot               https://tinyurl.com/bdfefdvh
# ------------------------------------------------------------------------------
  geom_sigmoid(data = dt_data,
    aes(x    = min(dt_data$x),
        xend = max(dt_data$x),
        y    = min(dt_data$y),
        yend = max(dt_data$y))) +
# ------------------------------------------------------------------------------
# label text 
# ------------------------------------------------------------------------------
  geom_text(
#    aes(label = label)) +
    aes(label = dt_data$label),
    hjust = 1.30,
    vjust = 1.00) +
# ------------------------------------------------------------------------------
# Add multiple text ranges to plot boundary
# ------------------------------------------------------------------------------
  annotate("text",
    x = (dt_data$boundry_left / 2),
    y = (max(dt_data[,6]) * 20) + .19,
    label = "GROW") +
  annotate("text",
    x = (dt_data$boundry_left + dt_data$boundry_right) / 2,
    y = (max(dt_data[,6]) * 20) + .19,
    label = "OPTIMISE") +
  annotate("text",
    x = (max(dt_data$boundry_right + max(dt_data$x)))/2,
    y = (max(dt_data[,6]) * 20) + .19,
    label = "CANNIBALISE")  +
# ------------------------------------------------------------------------------
# Title
# ------------------------------------------------------------------------------
#  ggtitle(paste0(format(as.Date(input$date_start.1.1.4),"%h-%Y"), "-",
#    stringr::str_to_title(dt_data$msa_name), " Market Share Saturation"),
#          subtitle = format(as.Date(input$date_start.1.1.4),"%Y-%h")) +
#  ggeasy::easy_center_title()  +  
# ------------------------------------------------------------------------------
# x & y axis
# ------------------------------------------------------------------------------
  labs(x = "Outlet Share", y = "Market Share")
          
      ) 
  })
```

###

```{r 1.1.2.2-viz-s-curve-monmouth, echo = F, fig.cap="Test", out.width = '33%'}
renderPlotly({
  dt_data <- data.table(
    dt_plt_data[
      msa == 1 &
      brand_type == input$radio.1.1.2 & 
      date_start == as.Date("2021-07-03"),
      ]
    )
  ggplotly(
    ggplot(,
      aes(
        x = dt_data$x,
        y = dt_data$y,
        xend = max(dt_data$x),
        yend = max(dt_data$y)),
        label = label) +
  geom_point(
    colour = dt_data$y2,
    size = 2) +
# ------------------------------------------------------------------------------
# mer slope line / s-curve boundry lines
# ------------------------------------------------------------------------------
  geom_abline(intercept = 0, slope = 1,  color = "blue", size = 0.75) +
# ------------------------------------------------------------------------------
  geom_vline(xintercept = dt_data$boundry_left,  color = "blue", size = 0.250) +
  geom_vline(xintercept = dt_data$boundry_right, color = "blue", size = 0.250) +
# ------------------------------------------------------------------------------
# shaded boundary area
# ------------------------------------------------------------------------------
  geom_rect(
    aes(xmin = dt_data$boundry_left,
        xmax = dt_data$boundry_right,
        ymin = -Inf,
        ymax = Inf),
        fill = "blue",
        colour = NA,
        alpha = 0.05)  +
# ------------------------------------------------------------------------------
# Sigmoid s-curve - Add s curve to r ggplot         https://tinyurl.com/bdfefdvh
# Step 00.02: add-s-curve-to-r-ggplot               https://tinyurl.com/bdfefdvh
# ------------------------------------------------------------------------------
  geom_sigmoid(data = dt_data,
    aes(x    = min(dt_data$x),
        xend = max(dt_data$x),
        y    = min(dt_data$y),
        yend = max(dt_data$y))) +
# ------------------------------------------------------------------------------
# label text 
# ------------------------------------------------------------------------------
  geom_text(
#    aes(label = label)) +
    aes(label = dt_data$label),
    hjust = 1.30,
    vjust = 1.00) +
# ------------------------------------------------------------------------------
# Add multiple text ranges to plot boundary
# ------------------------------------------------------------------------------
  annotate("text",
    x = (dt_data$boundry_left / 2),
    y = (max(dt_data[,6]) * 20) + .19,
    label = "GROW") +
  annotate("text",
    x = (dt_data$boundry_left + dt_data$boundry_right) / 2,
    y = (max(dt_data[,6]) * 20) + .19,
    label = "OPTIMISE") +
  annotate("text",
    x = (max(dt_data$boundry_right + max(dt_data$x)))/2,
    y = (max(dt_data[,6]) * 20) + .19,
    label = "CANNIBALISE")  +
# ------------------------------------------------------------------------------
# Title
# ------------------------------------------------------------------------------
#  ggtitle(paste0(stringr::str_to_title(dt_data$msa_name), " MSA - Market Share Saturation"),
#          subtitle = "July 2021") +
#  ggeasy::easy_center_title()  +    
# ------------------------------------------------------------------------------
# x & y axis
# ------------------------------------------------------------------------------
  labs(x = "Outlet Share", y = "Market Share")
          
      ) 
  })
```

###

```{r 1.1.2.3-viz-s-curve-monmouth, echo = F, fig.cap = "2017", out.width = '33%'}
renderPlotly({
  dt_data <- data.table(
    dt_plt_data[
      msa == 1 &
      brand_type == input$radio.1.1.2 & 
      date_start == as.Date("2017-07-01"),
      ]
    )
  ggplotly(
    ggplot(,
      aes(
        x = dt_data$x,
        y = dt_data$y,
        xend = max(dt_data$x),
        yend = max(dt_data$y)),
        label = label) +
  geom_point(
    colour = dt_data$y2,
    size = 2) +
# ------------------------------------------------------------------------------
# mer slope line / s-curve boundry lines
# ------------------------------------------------------------------------------
  geom_abline(intercept = 0, slope = 1,  color = "blue", size = 0.75) +
# ------------------------------------------------------------------------------
  geom_vline(xintercept = dt_data$boundry_left,  color = "blue", size = 0.250) +
  geom_vline(xintercept = dt_data$boundry_right, color = "blue", size = 0.250) +
# ------------------------------------------------------------------------------
# shaded boundary area
# ------------------------------------------------------------------------------
  geom_rect(
    aes(xmin = dt_data$boundry_left,
        xmax = dt_data$boundry_right,
        ymin = -Inf,
        ymax = Inf),
        fill = "blue",
        colour = NA,
        alpha = 0.05)  +
# ------------------------------------------------------------------------------
# Sigmoid s-curve - Add s curve to r ggplot         https://tinyurl.com/bdfefdvh
# Step 00.02: add-s-curve-to-r-ggplot               https://tinyurl.com/bdfefdvh
# ------------------------------------------------------------------------------
  geom_sigmoid(data = dt_data,
    aes(x    = min(dt_data$x),
        xend = max(dt_data$x),
        y    = min(dt_data$y),
        yend = max(dt_data$y))) +
# ------------------------------------------------------------------------------
# label text 
# ------------------------------------------------------------------------------
  geom_text(
#    aes(label = label)) +
    aes(label = dt_data$label),
    hjust = 1.30,
    vjust = 1.00) +
# ------------------------------------------------------------------------------
# Add multiple text ranges to plot boundary
# ------------------------------------------------------------------------------
  annotate("text",
    x = (dt_data$boundry_left / 2),
    y = (max(dt_data[,6]) * 20) + .19,
    label = "GROW") +
  annotate("text",
    x = (dt_data$boundry_left + dt_data$boundry_right) / 2,
    y = (max(dt_data[,6]) * 20) + .19,
    label = "OPTIMISE") +
  annotate("text",
    x = (max(dt_data$boundry_right + max(dt_data$x)))/2,
    y = (max(dt_data[,6]) * 20) + .19,
    label = "CANNIBALISE")  +
# ------------------------------------------------------------------------------
# Title
# ------------------------------------------------------------------------------
#  ggtitle(paste0(stringr::str_to_title(dt_data$msa_name), " MSA - Market Share Saturation"),
#          subtitle = "July 2021") +
#  ggeasy::easy_center_title()  +    
# ------------------------------------------------------------------------------
# x & y axis
# ------------------------------------------------------------------------------
  labs(x = "Outlet Share", y = "Market Share")
          
      ) 
  })
```

2.1 Nashville {data-navmenu="2-Nashville" data-icon="fa-list"}
=====================================

Input {.sidebar}
-------------------------------------

```{r 2.0.0.0-sidebar-fnc}
dt_scurve <- reactive({
  dt_plt_data[brand_type == as.numeric(input$radio.2.1)]
})
```

```{r 2.0.0.1-sidebarInput}
dateRangeInput("dateRange.2.1",
  "Date Range",
  start = params$dateStart,
  end = Sys.Date(),
  min = params$dateStart,
  max = Sys.Date()
)
```

```{r 2.0.0.2-sidebarRadio}

radioButtons("radio.2.2", "Brand Type:",
              c("Corporate" = 1,
                "Gas" = 2,
                "Store" = 3
              )
            )
```

```{r 2.0.0.3-sidebarRadio}
radioButtons("radio.2.3", "Source:",
              c("Fleet" = 1,
                "Visit Count" = 2
              ), 
              selected = "2"
            )
```

Column {data-height=16%}
-------------------------------------

###

```{r 2.1.1.1-vbox-legend}

flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Nashville",
    color = "#041E42",
    icon = 'fa-cross')
  }
)

```

###

```{r 2.1.1.2-vbox-max-outlet-share}

flexdashboard::renderValueBox(
  {
# ------------------------------------------------------------------------------    
    maxOutlets <- max(dt.mkt.share[msa == 2 & brand_type == as.numeric(input$radio.2.2), 5])
# ------------------------------------------------------------------------------
    flexdashboard::valueBox(
      paste0("Max Outlets: ", as.character(maxOutlets)),
      color = "#041E42",
      icon  = "ion-cash"
    )
# ------------------------------------------------------------------------------  
  }
)
```

###

```{r 2.1.1.3.a-vbox-max-outlet-share-pct}

flexdashboard::renderValueBox(
  {
# ------------------------------------------------------------------------------    
    maxOutletShare <- percent(max(dt.mkt.share[msa == 2& brand_type == as.numeric(input$radio.2.2), 7]))
# ------------------------------------------------------------------------------
    flexdashboard::valueBox(
      paste0("Max Outlet Share: ", as.character(maxOutletShare)),
      color = "#041E42",
      icon  = "ion-cash"
    )
# ------------------------------------------------------------------------------  
  }
)
```

###

```{r 2.1.1.4-vbox-max-market-share-pct}

flexdashboard::renderValueBox(
  {
# ------------------------------------------------------------------------------    
    maxMarketShare <- percent(max(dt.mkt.share[msa == 2& brand_type == as.numeric(input$radio.2.2), 6]))
# ------------------------------------------------------------------------------
    flexdashboard::valueBox(
      paste0("Max Market Share: ", as.character(maxMarketShare)),
      color = "#041E42",
      icon  = "ion-cash"
    )
# ------------------------------------------------------------------------------  
  }

)
```

###

```{r 2.1.1.5-vbox-max-mer-pct}

flexdashboard::renderValueBox(
  {
# ------------------------------------------------------------------------------    
    maxMER <- sprintf(max(dt.mkt.share[msa == 2& brand_type == as.numeric(input$radio.2.2), 8]), fmt = '%#.2f')
# ------------------------------------------------------------------------------
    flexdashboard::valueBox(
      paste0("Max MER: ", as.character(maxMER)),
      color = "#041E42",
      icon  = "ion-cash"
    )
# ------------------------------------------------------------------------------  
  }

)
```

Row {data-height=48%}
-------------------------------------

### Nashville Market Share

```{r 2.1.2.1-table-Price}
DT::renderDataTable({
  ind     <- as.numeric(input$radio.2.2)
  dt_data <- data.table(dt.mkt.share[brand_type == ind, ])
  dt_data <- dt_data[msa == 2, c(16,19,4:5,7:6,8:9)]
  DT::datatable(dt_data,
    rownames = FALSE,
    extensions = c("Scroller"),
    filter = 'top',
    options = list(
      dom = 'ltipr'
      ,order = list(list(0, "desc"))
      ,pageLength = 20
      ,scrollX = TRUE
      ,scrollY = 280
      ,scroller = TRUE)
    ) %>%

    formatRound("outlets", 0) %>%
    formatStyle("outlets",
      background = styleColorBar(range(dt.mkt.share$outlets), "#041E42"),
      color = "#FFB81C "
    ) %>%    
    formatPercentage( c("mkt_share_pct", "outlet_share_pct"),2) %>%
    formatStyle("outlet_share_pct",
      background = styleColorBar(range(dt.mkt.share$outlet_share_pct), "#041E42"),
      color = "#FFB81C"
    ) %>%
    formatStyle("mkt_share_pct",
      background = styleColorBar(range(dt.mkt.share$mkt_share_pct), "#041E42"),
      color = "#FFB81C"
    )  %>%
    formatRound("mer", 2) %>%
    formatStyle("mer",
      background = styleColorBar(range(dt.mkt.share$mer), "#041E42"),
      color = "#FFB81C"
    ) 
})
```

Row {data-height=36%}
-------------------------------------

### Monmouth-Ocean S-Curve

```{r 2.1.3.1-viz-s-curve-monmouth, echo = F, fig.cap = "Monmouth S-Curve", out.width = '33%'}
# knitr::include_graphics(here::here("dashboard/png/", "monmouth.png"))
```

### Nashville S-Curve

```{r 2.1.3.2-viz-s-curve-nashville, echo = F, fig.cap = "Nashville S-Curve", out.width = '33%'}
knitr::include_graphics(here::here("dashboard/png/", "nashville.png"))
```

### Orlando S-Curve

```{r 2.1.3.3-viz-s-curve-orlando, echo = F, fig.cap = "Orlando S-Curve", out.width = '33%'}
# knitr::include_graphics(here::here("dashboard/png/", "orlando.png"))
```

3.1 Orlando {data-navmenu="3-Orlando" data-icon="fa-list"}
=====================================

Input {.sidebar}
-------------------------------------

```{r 3.0.0.0-sidebar-fnc}
dt_scurve <- reactive({
  dt_plt_data[brand_type == as.numeric(input$radio.3.1)]
})
```

```{r 3.0.0.1-sidebarInput}
dateRangeInput("dateRange.3.1",
  "Date Range",
  start = params$dateStart,
  end = Sys.Date(),
  min = params$dateStart,
  max = Sys.Date()
)
```

```{r 3.0.0.2-sidebarRadio}
radioButtons("radio.3.2", "Brand Type:",
              c("Corporate" = 1,
                "Gas" = 2,
                "Store" = 3
              )
            )
```

```{r 3.0.0.3-sidebarRadio}
radioButtons("radio.3.3", "Source:",
              c("Fleet" = 1,
                "Visit Count" = 2
              ),
              selected = "2"
            )
```

Column {data-height=16%}
-------------------------------------

###

```{r 3.1.1.1-vbox-legend}
flexdashboard::renderValueBox(
  {
  flexdashboard::valueBox(
    "Orlando",
    color = "#fc6a03",
    icon = 'fa-cross')
  }
)
```

###

```{r 3.1.1.2-vbox-max-outlet-share}

flexdashboard::renderValueBox(
  {
# ------------------------------------------------------------------------------    
    maxOutlets <- max(dt.mkt.share[msa == 3 & brand_type == as.numeric(input$radio.3.2), 5])
# ------------------------------------------------------------------------------
    flexdashboard::valueBox(
      paste0("Max Outlets: ", as.character(maxOutlets)),
      color = "#fc6a03",
      icon  = "ion-cash"
    )
# ------------------------------------------------------------------------------  
  }
)
```

###

```{r 3.1.1.3.a-vbox-max-outlet-share-pct}

flexdashboard::renderValueBox(
  {
# ------------------------------------------------------------------------------    
    maxOutletShare <- percent(max(dt.mkt.share[msa == 3 & brand_type == as.numeric(input$radio.3.2), 7]))
# ------------------------------------------------------------------------------
    flexdashboard::valueBox(
      paste0("Max Outlet Share: ", as.character(maxOutletShare)),
      color = "#fc6a03",
      icon  = "ion-cash"
    )
# ------------------------------------------------------------------------------  
  }
)
```

###

```{r 3.1.1.4-vbox-max-market-share-pct}

flexdashboard::renderValueBox(
  {
# ------------------------------------------------------------------------------    
    maxMarketShare <- percent(max(dt.mkt.share[msa == 3 & brand_type == as.numeric(input$radio.3.2), 6]))
# ------------------------------------------------------------------------------
    flexdashboard::valueBox(
      paste0("Max Market Share: ", as.character(maxMarketShare)),
      color = "#fc6a03",
      icon  = "ion-cash"
    )
# ------------------------------------------------------------------------------  
  }

)
```

###

```{r 3.1.1.5-vbox-max-mer-pct}

flexdashboard::renderValueBox(
  {
# ------------------------------------------------------------------------------    
    maxMER <- sprintf(max(dt.mkt.share[msa == 3 & brand_type == as.numeric(input$radio.3.2), 8]), fmt = '%#.2f')
# ------------------------------------------------------------------------------
    flexdashboard::valueBox(
      paste0("Max MER: ", as.character(maxMER)),
      color = "#fc6a03",
      icon  = "ion-cash"
    )
# ------------------------------------------------------------------------------  
  }

)
```

Row {data-height=48%}
-------------------------------------

### Orlando Market Share

```{r 3.1.2.1-table-Price}

DT::renderDataTable({
  ind     <- as.numeric(input$radio.3.2)
  dt_data <- data.table(dt.mkt.share[brand_type == ind, ])
  dt_data <- dt_data[msa == 3, c(16,19,4:5,7:6,8:9)]
  DT::datatable(dt_data,
    rownames = FALSE,
    extensions = c("Scroller"),
    filter = 'top',
    options = list(
      dom = 'ltipr'
      ,order = list(list(0, "desc"))
      ,pageLength = 20
      ,scrollX = TRUE
      ,scrollY = 280
      ,scroller = TRUE)
    ) %>%

    formatRound("outlets", 0) %>%
    formatStyle("outlets",
      background = styleColorBar(range(dt.mkt.share$outlets), "##fc6a03"),
      color = "#0021A5",
      fontWeight = 'bold'
    ) %>%    
    formatPercentage( c("mkt_share_pct", "outlet_share_pct"),2) %>%
    formatStyle("outlet_share_pct",
      background = styleColorBar(range(dt.mkt.share$outlet_share_pct), "#fc6a03"),
      color = "#0021A5",
      fontWeight = 'bold'
    ) %>%
    formatStyle("mkt_share_pct",
      background = styleColorBar(range(dt.mkt.share$mkt_share_pct), "#fc6a03"),
      color = "#0021A5",
      fontWeight = 'bold'
    )  %>%
    formatRound("mer", 2) %>%
    formatStyle("mer",
      background = styleColorBar(range(dt.mkt.share$mer), "#fc6a03"),
      color = "#0021A5",
      fontWeight = 'bold'
    ) 
})
```

Row {data-height=36%}
-------------------------------------

### Monmouth-Ocean S-Curve

```{r 3.1.3.1-viz-s-curve-monmouth, echo = F, fig.cap = "Monmouth S-Curve", out.width = '33%'}
# knitr::include_graphics(here::here("dashboard/png/", "monmouth.png"))
```

### Nashville S-Curve

```{r 3.1.3.2-viz-s-curve-nashville, echo = F, fig.cap = "Nashville S-Curve", out.width = '33%'}
# knitr::include_graphics(here::here("dashboard/png/", "nashville.png"))
```

### Orlando S-Curve

```{r 3.1.3.3-viz-s-curve-orlando, echo = F, fig.cap = "Orlando S-Curve", out.width = '33%'}
knitr::include_graphics(here::here("dashboard/png/", "orlando.png"))
```

99.0 Summary {data-navmenu="EDA" data-icon="fa-list"}
=====================================

Column {.tabset}
-----------------------------------------------------------------------

### Exploratory Data Analysis

First things first. Exploratory Data Analysis (EDA) is a mandatory first step. An excellent way to examine the inital data can be accomplished using the [dlookr](https://tinyurl.com/ws33jnsd) library. There are other EDA packages as well including:

- [DataExplorer](https://tinyurl.com/rkjaupwz) 
- [explore](https://tinyurl.com/af8kczbb)
- [inspectdf](https://alastairrushworth.github.io/inspectdf/)
- [see](https://github.com/easystats/see)
- [skimr](https://github.com/ropensci/skimr)
- [vis_dat](https://github.com/ropensci/visdat)

### Animation

- [How to create animation with GGAnimate](https://tinyurl.com/t98hhj3j)
- [Animated Plots using ggplot and gganimate](https://tinyurl.com/k6a3m67e)

Definitions: The transition_* functions define how the data subsets are derived and thus define the general character of any animation. There are three types of transitions:

##### __Defining the basic animation: transition_*__
- transition_states():  Here the data is split into subsets according to the categories of the variable provided to the states argument, e.g. date.
- transition_length(): total time for the transitions from one to the other subsets of data
- state_length(): how long, relatively speaking, each subset of the original data is displayed.
- transition_reveal()
- transition_filter()
- wrap(): endless loop(s)
  
##### Styling transitions: ease_aesv
- ease_aes()
- gganimate calculates additional data points to create smooth transitions between successively displayed points of actual input data. With ease_aes we can control which so-called easing function is used to ‘morph’ original data points into each other.
- The default argument is used to declare the easing function for all aesthetics in a plot. 
- Alternatively, easing functions can be assigned to individual aesthetics by name.
- These functions can be customized further by adding a modifier-suffix: with -in the function is applied as-is, with -out the function is reversely applied with -in-out the function is applied as-is in the first half of the transition and reversed in the second half.
- ease_aes("bounce-in")

##### Dynamic labelling: {frame variables}

Frame variables provide metadata about the animation as a whole or the previous/current/next frame. The frame variables – when wrapped in curly brackets – are available for string literal interpretation within all plot labels. For example, we can label each frame with the value of the states variable that defines the currently (or soon to be) displayed subset of actual data:
- labs(subtitle = "{closest_state}") 
- The set of available variables depends on the transition function. To get a list of frame variables available for any animation (per default the last one) the frame_vars() function can be called, to get both the names and values of the available variables.

##### Indicating previous data: shadow_*


##### transition events
data <- data.frame(
  x = 1:10,
  y = runif(10),
  begin = runif(10, 1, 100),
  length = runif(10, 5, 20),
  enter = runif(10, 5, 10),
  exit = runif(10, 5, 10)
)

anim <- ggplot(data, aes(x, y)) +
  geom_col() +
  transition_events(start = begin,
                    end = begin + length,
                    enter_length = enter,
                    exit_length = exit) +
 enter_grow() +
 exit_drift(x_mod = 11) +
 exit_fade()

##### transition_components:

-	Independent animation of plot elements (by group).

##### transition_events

- Define entrance and exit times of each visual element (row of data).
- 
##### transition_layers: (geom_rect())?

- Animate the addition of layers to the plot. Can also remove layers.



